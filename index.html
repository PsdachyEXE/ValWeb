<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For You</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=DM+Sans:wght@400;500;700&family=Dela+Gothic+One&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="preload" href="assets/67-audio.mp3" as="audio">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Backgrounds */
            --bg-cream: #FFF8F0;
            --bg-blush: #FFF0F3;
            --bg-white: #FFFFFF;
            --bg-black: #000000;

            /* Text */
            --text-primary: #3D2C2C;
            --text-muted: #7A6565;

            /* Accents */
            --rose: #E8657A;
            --rose-hover: #D4506A;
            --rose-light: #FADADD;
            --rose-glow: rgba(232, 101, 122, 0.2);
            --gold: #E8B86D;
            --success: #6DBF7B;
            --error: #E74C3C;

            /* Buttons */
            --btn-no-bg: #F5E6E8;
            --btn-no-hover: #EDD5D8;

            /* Shadows */
            --shadow-soft: 0 2px 12px rgba(61, 44, 44, 0.08);
            --shadow-btn: 0 2px 8px rgba(232, 101, 122, 0.25);
            --shadow-btn-hover: 0 4px 16px rgba(232, 101, 122, 0.35);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--bg-cream), var(--bg-blush), #FFF5EE, var(--bg-cream));
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Custom cursor for desktop */
        @media (hover: hover) {
            body {
                cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18'%3E%3Cpath d='M9 2c-3 0-5.5 2.5-5.5 5.5S9 16 9 16s5.5-5.5 5.5-8.5S12 2 9 2z' fill='%23E8657A'/%3E%3C/svg%3E") 9 9, auto;
            }
        }

        @keyframes gradientBG {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Sparkle cursor trail */
        .sparkle {
            position: fixed;
            pointer-events: none;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            z-index: 9999;
            animation: sparkle-fade 0.3s ease-out forwards;
        }

        @keyframes sparkle-fade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.3); }
        }

        /* Sound Toggle */
        .sound-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1001;
            background: rgba(61, 44, 44, 0.06);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-out;
        }

        .sound-toggle:hover {
            background: rgba(61, 44, 44, 0.1);
        }

        /* Page Containers */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity 0.4s ease-out, visibility 0.4s ease-out, transform 0.4s ease-out;
            padding: 20px;
            z-index: 1;
        }

        .page.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Floating Particles */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .particle {
            position: absolute;
            animation: floatUp var(--duration, 10s) ease-in-out infinite;
            animation-delay: var(--delay, 0s);
        }

        .particle.heart {
            color: var(--rose);
            font-size: var(--size, 12px);
            opacity: var(--opacity, 0.4);
        }

        .particle.sparkle {
            width: var(--size, 4px);
            height: var(--size, 4px);
            background: var(--gold);
            border-radius: 50%;
            opacity: var(--opacity, 0.3);
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% { opacity: var(--opacity, 0.4); }
            90% { opacity: var(--opacity, 0.4); }
            100% {
                transform: translateY(-50px) translateX(var(--drift, 20px));
                opacity: 0;
            }
        }

        /* ============================================
           PIXEL ART TAMAGOTCHI
           ============================================ */
        .tamagotchi-wrapper {
            position: relative;
        }

        .tamagotchi-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(232, 101, 122, 0.12) 0%, transparent 70%);
            pointer-events: none;
        }

        .tamagotchi {
            width: 120px;
            height: 120px;
            position: relative;
            transition: transform 0.3s ease-out;
        }

        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            grid-template-rows: repeat(16, 1fr);
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .pixel { aspect-ratio: 1; }

        /* Tamagotchi Colors */
        .p-body { background: #FFF176; }
        .p-ear { background: #1A237E; }
        .p-eye { background: #1A237E; }
        .p-eye-highlight { background: #FFFFFF; }
        .p-cheek { background: #F48FB1; }
        .p-mouth { background: #D32F2F; }
        .p-outline { background: #333333; }
        .p-clear { background: transparent; }

        .tamagotchi.idle { animation: idleFloat 2s ease-in-out infinite; }
        .tamagotchi.excited { animation: excitedBounce 0.3s ease-in-out; }
        .tamagotchi.wave { animation: wave 0.5s ease-in-out; }
        .tamagotchi.celebrating { animation: celebrate 1s ease-in-out infinite; }

        @keyframes idleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes excitedBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }

        @keyframes celebrate {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        /* Popup Tamagotchi */
        .popup-tamagotchi {
            position: fixed;
            top: -120px;
            left: 50%;
            transform: translateX(-50%) translateY(-120px);
            width: 100px;
            height: 100px;
            z-index: 100;
            transition: transform 0.3s ease-out;
        }

        .popup-tamagotchi.show { transform: translateX(-50%) translateY(60px); }
        .popup-tamagotchi.peek { transform: translateX(-50%) translateY(-30px) !important; }
        .popup-tamagotchi.wiggle { animation: wiggle 0.4s ease-in-out; }
        .popup-tamagotchi.droopy { animation: droopy 0.6s ease-in-out; }

        @keyframes wiggle {
            0%, 100% { transform: translateX(-50%) translateY(60px) rotate(0deg); }
            25% { transform: translateX(-50%) translateY(60px) rotate(-8deg); }
            75% { transform: translateX(-50%) translateY(60px) rotate(8deg); }
        }

        @keyframes droopy {
            0%, 100% { transform: translateX(-50%) translateY(60px); }
            50% { transform: translateX(-50%) translateY(70px); }
        }

        /* Pixel elements for reactions */
        .pixel-exclaim {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 16px;
            background: var(--error);
            display: none;
        }

        .pixel-exclaim::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--error);
        }

        .popup-tamagotchi.show-exclaim .pixel-exclaim { display: block; }

        .pixel-tear {
            position: absolute;
            top: 40px;
            right: 20px;
            width: 4px;
            height: 6px;
            background: #64B5F6;
            border-radius: 50% 50% 50% 50% / 30% 30% 70% 70%;
            display: none;
            animation: tearFall 0.8s ease-in forwards;
        }

        .popup-tamagotchi.show-tear .pixel-tear { display: block; }

        @keyframes tearFall {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(15px); }
        }

        /* ============================================
           PIXEL ART CANNON
           ============================================ */
        .cannon-container {
            position: fixed;
            bottom: 15%;
            left: -200px;
            width: 180px;
            height: 120px;
            transition: left 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 10;
        }

        .cannon-container.roll-in { left: 20%; }

        .cannon-pixel-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            grid-template-rows: repeat(16, 1fr);
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .c-barrel { background: #37474F; }
        .c-barrel-dark { background: #263238; }
        .c-barrel-light { background: #546E7A; }
        .c-base { background: #455A64; }
        .c-wheel { background: #263238; }
        .c-wheel-hub { background: #546E7A; }
        .c-clear { background: transparent; }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            padding: 12px 36px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease-out;
            min-width: 120px;
            min-height: 48px;
        }

        .btn-primary {
            background: var(--rose);
            color: white;
            box-shadow: var(--shadow-btn);
        }

        .btn-primary:hover {
            background: var(--rose-hover);
            box-shadow: var(--shadow-btn-hover);
            transform: scale(1.03);
        }

        .btn-primary:active {
            transform: scale(0.97);
        }

        .btn-primary.pulse {
            animation: pulse 2.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .btn-secondary {
            background: var(--btn-no-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 4px rgba(61, 44, 44, 0.06);
        }

        .btn-secondary:hover {
            background: var(--btn-no-hover);
            box-shadow: 0 2px 8px rgba(61, 44, 44, 0.1);
        }

        .btn-broken {
            background: var(--btn-no-bg);
            color: var(--text-primary);
            transform: rotate(3deg);
            opacity: 0.45;
            cursor: not-allowed;
            filter: grayscale(0.5);
            position: relative;
        }

        .btn-broken::after {
            content: '';
            position: absolute;
            top: 30%;
            left: 10%;
            width: 80%;
            height: 2px;
            background: rgba(0, 0, 0, 0.3);
            transform: rotate(-15deg);
        }

        /* ============================================
           TYPEWRITER
           ============================================ */
        .typewriter {
            font-family: 'Caveat', cursive;
            font-weight: 700;
            font-size: clamp(24px, 5vw, 32px);
            color: var(--text-primary);
            text-align: center;
            margin: 30px 0;
            min-height: 40px;
        }

        .typewriter .cursor {
            display: inline-block;
            width: 2px;
            height: 0.9em;
            background: var(--rose);
            margin-left: 2px;
            animation: blink 0.8s step-end infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* ============================================
           LANDING PAGE
           ============================================ */
        #landing .tamagotchi-wrapper {
            margin-top: -10vh;
        }

        /* ============================================
           QUESTION PAGE
           ============================================ */
        #question { gap: 20px; }

        .question-text {
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            font-size: clamp(28px, 6vw, 48px);
            color: var(--text-primary);
            text-align: center;
        }

        .question-text .word {
            display: inline-block;
            opacity: 0;
            transform: translateY(12px);
            transition: all 0.15s ease-out;
        }

        .question-text .word.show {
            opacity: 1;
            transform: translateY(0);
        }

        .buttons-container {
            display: flex;
            gap: 16px;
            margin-top: 30px;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        .buttons-container.show { opacity: 1; }

        .no-btn {
            position: absolute;
            transition: all 180ms cubic-bezier(0.2, 0, 0, 1);
        }

        .question-change-text {
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: clamp(18px, 4vw, 24px);
            color: var(--text-muted);
        }

        /* ============================================
           CAPTCHA PAGE
           ============================================ */
        #captcha {
            background: var(--bg-blush);
        }

        .captcha-header {
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            font-size: clamp(20px, 4vw, 28px);
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .captcha-subheader {
            font-family: 'DM Sans', sans-serif;
            font-weight: 400;
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .captcha-box {
            background: var(--bg-white);
            border: 1px solid rgba(61, 44, 44, 0.1);
            border-radius: 16px;
            padding: 20px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(61, 44, 44, 0.08);
        }

        .captcha-prompt {
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .captcha-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        /* Polaroid Style */
        .polaroid {
            background: white;
            padding: 6px 6px 24px 6px;
            border: 1px solid rgba(61, 44, 44, 0.06);
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(61, 44, 44, 0.1);
            cursor: pointer;
            transition: all 0.2s ease-out;
            position: relative;
        }

        .polaroid-inner {
            aspect-ratio: 1;
            background: #e8e8e8;
            overflow: hidden;
            position: relative;
        }

        .polaroid-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .polaroid-inner.stock img {
            filter: saturate(0.8) brightness(0.97);
        }

        .polaroid:hover {
            transform: rotate(0deg) translateY(-3px) scale(1.03);
            box-shadow: 0 4px 12px rgba(61, 44, 44, 0.15);
        }

        .polaroid.selected {
            border: 2px solid var(--rose);
        }

        .polaroid.selected .checkmark { display: flex; }

        .polaroid.error {
            border-color: var(--error);
            animation: shake 0.3s ease-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .checkmark {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            background: var(--rose);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .captcha-verify-btn {
            width: 100%;
            padding: 14px;
            background: var(--rose);
            color: white;
            border: none;
            border-radius: 50px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-out;
            box-shadow: var(--shadow-btn);
        }

        .captcha-verify-btn:hover:not(:disabled) {
            background: var(--rose-hover);
            box-shadow: var(--shadow-btn-hover);
        }

        .captcha-verify-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .captcha-status {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .captcha-spinner {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .captcha-spinner .dot {
            width: 10px;
            height: 10px;
            background: var(--rose);
            border-radius: 50%;
            animation: bounce 0.6s ease-in-out infinite;
        }

        .captcha-spinner .dot:nth-child(2) { animation-delay: 0.1s; }
        .captcha-spinner .dot:nth-child(3) { animation-delay: 0.2s; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .captcha-checkmark {
            color: var(--success);
            font-size: 32px;
            margin-bottom: 12px;
        }

        .captcha-message {
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
        }

        .captcha-message.error {
            color: var(--error);
        }

        .captcha-result-area {
            margin-top: 24px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        .captcha-result-area.show { opacity: 1; }

        .captcha-result-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 16px;
        }

        .captcha-hint {
            font-family: 'DM Sans', sans-serif;
            font-weight: 400;
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        .captcha-hint.show { opacity: 1; }

        /* Toast for stock rejection */
        .rejection-toast {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            color: var(--error);
            white-space: nowrap;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: toastFloat 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes toastFloat {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* ============================================
           CANNON TRANSITION PAGE
           ============================================ */
        #cannon-transition {
            background: var(--bg-white);
        }

        .screen-shake { animation: screenShake 0.2s ease-out; }

        @keyframes screenShake {
            0%, 100% { transform: translate(0, 0); }
            20% { transform: translate(-3px, 2px); }
            40% { transform: translate(3px, -2px); }
            60% { transform: translate(-2px, 3px); }
            80% { transform: translate(2px, -2px); }
        }

        /* ============================================
           I LOVE YOU PAGE
           ============================================ */
        #iloveyou {
            background: var(--bg-cream);
        }

        .love-text {
            font-family: 'Playfair Display', serif;
            font-weight: 900;
            font-size: clamp(36px, 8vw, 64px);
            color: var(--text-primary);
            text-align: center;
            text-shadow: 0 1px 2px rgba(232, 101, 122, 0.15);
            opacity: 0;
            transform: scale(0.96);
            transition: all 1s ease-out;
        }

        .love-text.show {
            opacity: 1;
            transform: scale(1);
        }

        .love-btn {
            margin-top: 40px;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        .love-btn.show {
            opacity: 1;
            animation: heartbeat 0.9s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            14% { transform: scale(1.04); }
            28% { transform: scale(1); }
            42% { transform: scale(1.07); }
            56% { transform: scale(1); }
        }

        .ellipsis-dot {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        .ellipsis-dot.show { opacity: 1; }

        /* ============================================
           BLACKOUT PAGE
           ============================================ */
        #blackout {
            background: var(--bg-black);
            overflow: hidden;
        }

        .flicker { animation: flicker 0.15s steps(3); }

        @keyframes flicker {
            0% { opacity: 0; }
            33% { opacity: 1; }
            66% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .sixtyseven-text {
            font-family: 'Dela Gothic One', cursive;
            font-size: clamp(40px, 15vw, 130px);
            color: white;
            white-space: nowrap;
            position: absolute;
            transform: translateX(100vw);
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.4), 0 0 60px rgba(232, 101, 122, 0.25);
        }

        .sixtyseven-text.slide {
            animation: slideAcross 2s linear forwards;
        }

        @keyframes slideAcross {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100vw); }
        }

        .screen-rumble { animation: screenRumble 2s linear; }

        @keyframes screenRumble {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-2px, 1px); }
            20% { transform: translate(2px, -1px); }
            30% { transform: translate(-1px, 2px); }
            40% { transform: translate(1px, -1px); }
            50% { transform: translate(-2px, 1px); }
            60% { transform: translate(1px, -2px); }
            70% { transform: translate(-1px, 1px); }
            80% { transform: translate(2px, -1px); }
            90% { transform: translate(-1px, 2px); }
        }

        /* ============================================
           VICTORY PAGE
           ============================================ */
        #victory {
            background: var(--bg-blush);
        }

        .victory-tamagotchi {
            margin-bottom: 40px;
            position: relative;
        }

        .victory-tamagotchi .tamagotchi-glow {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(232, 101, 122, 0.15) 0%, transparent 70%);
        }

        .victory-hearts {
            position: absolute;
            width: 140px;
            height: 80px;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
        }

        .victory-heart {
            position: absolute;
            font-size: 10px;
            color: var(--rose);
            animation: victoryHeartFloat 2s ease-in-out infinite;
        }

        @keyframes victoryHeartFloat {
            0%, 100% { transform: translateY(0); opacity: 0.8; }
            50% { transform: translateY(-20px); opacity: 0.4; }
        }

        .victory-content { text-align: center; }

        .victory-line {
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.4s ease-out;
        }

        .victory-line.show {
            opacity: 1;
            transform: translateY(0);
        }

        .victory-title {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: clamp(28px, 5vw, 42px);
            color: var(--rose);
            margin-bottom: 24px;
        }

        .victory-date {
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: clamp(16px, 3vw, 20px);
            color: var(--text-primary);
            margin: 4px 0;
        }

        .victory-time {
            font-family: 'DM Sans', sans-serif;
            font-weight: 400;
            font-size: clamp(14px, 2.5vw, 18px);
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .victory-personal {
            font-family: 'Caveat', cursive;
            font-weight: 700;
            font-size: clamp(18px, 3.5vw, 24px);
            color: var(--text-primary);
            margin: 4px 0;
        }

        .victory-hint {
            font-family: 'Caveat', cursive;
            font-weight: 700;
            font-size: clamp(15px, 3vw, 20px);
            color: var(--rose);
            opacity: 0.7;
        }

        .calendar-link {
            display: inline-block;
            margin-top: 24px;
            background: var(--btn-no-bg);
            color: var(--rose);
            font-family: 'DM Sans', sans-serif;
            font-weight: 400;
            font-size: 14px;
            text-decoration: none;
            padding: 10px 24px;
            border: 1px solid rgba(232, 101, 122, 0.2);
            border-radius: 50px;
            transition: all 0.2s ease-out;
        }

        .calendar-link:hover {
            background: var(--btn-no-hover);
        }

        /* ============================================
           MOBILE ADJUSTMENTS
           ============================================ */
        @media (max-width: 480px) {
            .captcha-box {
                padding: 16px;
            }

            .polaroid {
                padding: 4px 4px 16px 4px;
            }

            .buttons-container {
                flex-direction: column;
                align-items: center;
            }

            .cannon-container {
                width: 140px;
                height: 90px;
            }

            .cannon-container.roll-in { left: 10%; }
        }
    </style>
</head>
<body>
    <!-- Sound Toggle -->
    <button class="sound-toggle" id="soundToggle" aria-label="Toggle sound">
        <span id="soundIcon"></span>
    </button>

    <!-- Floating Particles -->
    <div class="particles-container" id="particlesContainer"></div>

    <!-- Popup Tamagotchi -->
    <div class="popup-tamagotchi" id="popupTamagotchi">
        <div class="pixel-exclaim"></div>
        <div class="pixel-tear"></div>
        <div class="pixel-grid" id="popupTamaGrid"></div>
    </div>

    <!-- Page 1: Landing -->
    <div class="page active" id="landing">
        <div class="tamagotchi-wrapper">
            <div class="tamagotchi-glow"></div>
            <div class="tamagotchi idle" id="landingTamagotchi">
                <div class="pixel-grid" id="landingTamaGrid"></div>
            </div>
        </div>
        <div class="typewriter" id="typewriter">
            <span id="typewriterText"></span>
            <span class="cursor"></span>
        </div>
        <button class="btn btn-primary pulse" id="continueBtn" style="opacity: 0;">Continue</button>
    </div>

    <!-- Page 2: Question -->
    <div class="page" id="question">
        <p class="question-text" id="questionText">
            <span class="word">Will</span>
            <span class="word">you</span>
            <span class="word">be</span>
            <span class="word">my</span>
            <span class="word">Valentine?</span>
        </p>
        <div class="buttons-container" id="buttonsContainer">
            <button class="btn btn-primary" id="yesBtn">Yes</button>
            <button class="btn btn-secondary no-btn" id="noBtn">No</button>
        </div>
    </div>

    <!-- Page 3: CAPTCHA -->
    <div class="page" id="captcha">
        <h2 class="captcha-header">One more thing...</h2>
        <p class="captcha-subheader">Complete this security check to continue</p>
        <div class="captcha-box">
            <p class="captcha-prompt">Select all images containing husband material</p>
            <div class="captcha-grid" id="captchaGrid"></div>
            <button class="captcha-verify-btn" id="verifyBtn" disabled>Verify</button>
            <div class="captcha-status" id="captchaStatus">
                <div class="captcha-spinner" id="captchaSpinner">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <div class="captcha-checkmark" id="captchaCheckmark" style="display:none;">&#10003;</div>
                <p class="captcha-message" id="captchaMessage"></p>
            </div>
        </div>
        <div class="captcha-result-area" id="captchaResultArea">
            <p class="captcha-message" id="captchaResultText"></p>
            <div class="captcha-result-buttons">
                <button class="btn btn-primary pulse" id="captchaYesBtn" style="display:none;">Yes</button>
                <button class="btn btn-broken" id="captchaNoBroken" style="display:none;">No</button>
            </div>
            <p class="captcha-hint" id="captchaHint">Looks like there's only one option...</p>
        </div>
    </div>

    <!-- Page 5: Cannon Transition -->
    <div class="page" id="cannon-transition">
        <div class="cannon-container" id="cannon">
            <div class="cannon-pixel-grid" id="cannonGrid"></div>
        </div>
    </div>

    <!-- Page 6: I Love You -->
    <div class="page" id="iloveyou">
        <p class="love-text" id="loveText">I love you</p>
        <button class="btn btn-primary love-btn" id="loveTooBtn">I love you too!</button>
    </div>

    <!-- Blackout Page -->
    <div class="page" id="blackout">
        <p class="sixtyseven-text" id="sixtysevenText">SIIIIIXXX SEVVENNNNNN</p>
    </div>

    <!-- Page 7: Victory -->
    <div class="page" id="victory">
        <div class="victory-tamagotchi">
            <div class="tamagotchi-glow"></div>
            <div class="victory-hearts" id="victoryHearts"></div>
            <div class="tamagotchi celebrating" id="victoryTamagotchi">
                <div class="pixel-grid" id="victoryTamaGrid"></div>
            </div>
        </div>
        <div class="victory-content">
            <h1 class="victory-title victory-line">It's a date.</h1>
            <p class="victory-date victory-line">Saturday, February 14th</p>
            <p class="victory-time victory-line">10:00 AM</p>
            <p class="victory-personal victory-line">We're recreating our first date.</p>
            <p class="victory-hint victory-line">(plus a few surprises)</p>
            <a href="#" class="calendar-link victory-line" id="calendarLink">Add to Calendar</a>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        const state = {
            currentPage: 'landing',
            noClickCount: 0,
            captchaSelections: [],
            soundEnabled: true,
            isTransitioning: false,
            lastButtonClick: 0
        };

        // ============================================
        // PIXEL ART DATA
        // ============================================
        const tamaIdle = [
            [0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],
            [0,0,0,3,3,3,3,3,3,3,3,3,3,0,0,0],
            [0,0,3,3,3,1,1,1,1,1,1,3,3,3,0,0],
            [0,0,1,1,1,2,2,2,2,2,2,1,1,1,0,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
            [0,1,2,2,4,4,2,2,2,2,4,4,2,2,1,0],
            [0,1,2,2,4,5,2,2,2,2,4,5,2,2,1,0],
            [0,1,2,6,2,2,2,2,2,2,2,2,6,2,1,0],
            [0,1,2,2,2,2,2,7,7,2,2,2,2,2,1,0],
            [0,1,2,2,2,2,7,2,2,7,2,2,2,2,1,0],
            [0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0],
            [0,1,2,1,2,2,2,2,2,2,2,2,1,2,1,0],
            [0,1,2,2,1,1,2,2,2,2,1,1,2,2,1,0],
            [0,0,1,2,2,2,1,1,1,1,2,2,2,1,0,0],
            [0,0,0,1,1,2,2,2,2,2,2,1,1,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0]
        ];

        const tamaExcited = [
            [0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],
            [0,0,0,3,3,3,3,3,3,3,3,3,3,0,0,0],
            [0,0,3,3,3,1,1,1,1,1,1,3,3,3,0,0],
            [0,0,1,1,1,2,2,2,2,2,2,1,1,1,0,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
            [0,1,2,2,1,1,2,2,2,2,1,1,2,2,1,0],
            [0,1,2,2,4,5,2,2,2,2,4,5,2,2,1,0],
            [0,1,2,6,2,2,2,2,2,2,2,2,6,2,1,0],
            [0,1,2,2,2,2,7,7,7,7,2,2,2,2,1,0],
            [0,1,2,2,2,7,2,2,2,2,7,2,2,2,1,0],
            [1,2,1,2,2,2,2,2,2,2,2,2,2,1,2,1],
            [1,2,2,1,2,2,2,2,2,2,2,2,1,2,2,1],
            [0,1,2,2,1,1,2,2,2,2,1,1,2,2,1,0],
            [0,0,1,2,2,2,1,1,1,1,2,2,2,1,0,0],
            [0,0,0,1,1,2,2,2,2,2,2,1,1,0,0,0],
            [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0]
        ];

        const tamaSad = [
            [0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],
            [0,0,0,3,3,3,3,3,3,3,3,3,3,0,0,0],
            [0,0,3,3,3,1,1,1,1,1,1,3,3,3,0,0],
            [0,0,1,1,1,2,2,2,2,2,2,1,1,1,0,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
            [0,1,2,2,4,4,2,2,2,2,4,4,2,2,1,0],
            [0,1,2,6,4,5,2,2,2,2,4,5,6,2,1,0],
            [0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
            [0,1,2,2,2,2,2,1,1,2,2,2,2,2,1,0],
            [0,0,1,2,2,2,1,2,2,1,2,2,2,1,0,0],
            [0,1,2,1,2,2,2,2,2,2,2,2,1,2,1,0],
            [0,0,1,2,1,1,2,2,2,2,1,1,2,1,0,0],
            [0,0,0,1,2,2,1,1,1,1,2,2,1,0,0,0],
            [0,0,0,0,1,1,2,2,2,2,1,1,0,0,0,0],
            [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0]
        ];

        const colorMap = {
            0: 'p-clear', 1: 'p-outline', 2: 'p-body', 3: 'p-ear',
            4: 'p-eye', 5: 'p-eye-highlight', 6: 'p-cheek', 7: 'p-mouth'
        };

        const cannonData = [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,3,3,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,1,1,3,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,1,1,1,3,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,1,1,1,3,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,3,1,1,2,2,2,3,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,0,3,1,1,2,2,2,3,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,0,3,1,1,2,2,2,3,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,0,3,1,1,2,2,2,3,0,0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0,0,3,1,1,2,2,2,3,0,0,0,0,0,0,0,0,0],
            [0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,0,0,0],
            [0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,0,0],
            [0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,0,0,0,0],
            [0,0,5,5,6,5,0,0,0,0,0,0,0,0,0,0,5,5,6,5,0,0,0,0],
            [0,5,6,6,6,6,5,0,0,0,0,0,0,0,0,5,6,6,6,6,5,0,0,0],
            [0,0,5,5,6,5,0,0,0,0,0,0,0,0,0,0,5,5,6,5,0,0,0,0]
        ];

        const cannonColorMap = {
            0: 'c-clear', 1: 'c-barrel-light', 2: 'c-barrel-dark',
            3: 'c-barrel', 4: 'c-base', 5: 'c-wheel', 6: 'c-wheel-hub'
        };

        // ============================================
        // RENDER PIXEL ART
        // ============================================
        function renderPixelGrid(container, data, colorMapObj) {
            container.innerHTML = '';
            data.forEach(row => {
                row.forEach(pixel => {
                    const div = document.createElement('div');
                    div.className = `pixel ${colorMapObj[pixel]}`;
                    container.appendChild(div);
                });
            });
        }

        function setTamagotchiState(gridId, stateName) {
            const grid = document.getElementById(gridId);
            const stateMap = { idle: tamaIdle, excited: tamaExcited, sad: tamaSad };
            renderPixelGrid(grid, stateMap[stateName] || tamaIdle, colorMap);
        }

        // ============================================
        // UTILITIES
        // ============================================
        function debounce(func, wait = 200) {
            return function(...args) {
                const now = Date.now();
                if (now - state.lastButtonClick < wait) return;
                state.lastButtonClick = now;
                func.apply(this, args);
            };
        }

        // ============================================
        // ELEMENTS
        // ============================================
        const soundToggle = document.getElementById('soundToggle');
        const soundIcon = document.getElementById('soundIcon');
        const particlesContainer = document.getElementById('particlesContainer');
        const landingTamagotchi = document.getElementById('landingTamagotchi');
        const continueBtn = document.getElementById('continueBtn');
        const yesBtn = document.getElementById('yesBtn');
        const noBtn = document.getElementById('noBtn');
        const popupTamagotchi = document.getElementById('popupTamagotchi');
        const captchaGrid = document.getElementById('captchaGrid');
        const verifyBtn = document.getElementById('verifyBtn');

        // Audio
        let audio67;
        try {
            audio67 = new Audio('assets/67-audio.mp3');
            audio67.load();
        } catch (e) {}

        // ============================================
        // CURSOR SPARKLE TRAIL (Desktop only)
        // ============================================
        let lastSparkle = 0;
        const isDesktop = window.matchMedia('(hover: hover)').matches;

        if (isDesktop) {
            document.addEventListener('mousemove', (e) => {
                const now = Date.now();
                if (now - lastSparkle < 60) return;
                lastSparkle = now;

                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = (e.clientX + (Math.random() - 0.5) * 8) + 'px';
                sparkle.style.top = (e.clientY + (Math.random() - 0.5) * 8) + 'px';
                sparkle.style.background = Math.random() > 0.5 ? '#E8657A' : '#E8B86D';
                document.body.appendChild(sparkle);

                setTimeout(() => sparkle.remove(), 300);
            });
        }

        // ============================================
        // PRELOAD ASSETS
        // ============================================
        function preloadAssets() {
            const images = [
                ...Array.from({length: 6}, (_, i) => `assets/captcha/lachie-${i + 1}.jpg`),
                ...Array.from({length: 3}, (_, i) => `assets/captcha/stock-${i + 1}.jpg`)
            ];
            images.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        // ============================================
        // SOUND TOGGLE
        // ============================================
        function updateSoundIcon() {
            soundIcon.textContent = state.soundEnabled ? '\u{1F50A}' : '\u{1F507}';
        }

        soundToggle.addEventListener('click', () => {
            state.soundEnabled = !state.soundEnabled;
            updateSoundIcon();
        });

        // ============================================
        // PARTICLES
        // ============================================
        function createParticles() {
            const isMobile = window.innerWidth <= 480;
            const count = isMobile ? 6 : 12;
            particlesContainer.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                const isHeart = Math.random() > 0.4;

                particle.className = `particle ${isHeart ? 'heart' : 'sparkle'}`;
                if (isHeart) particle.textContent = '\u2764';

                const size = isHeart ? (10 + Math.random() * 4) : (3 + Math.random() * 2);
                const opacity = isHeart ? (0.3 + Math.random() * 0.2) : (0.2 + Math.random() * 0.2);
                const duration = 8 + Math.random() * 4;
                const delay = Math.random() * duration;
                const drift = (Math.random() - 0.5) * 60;

                particle.style.setProperty('--size', size + 'px');
                particle.style.setProperty('--opacity', opacity);
                particle.style.setProperty('--duration', duration + 's');
                particle.style.setProperty('--delay', delay + 's');
                particle.style.setProperty('--drift', drift + 'px');
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.fontSize = size + 'px';

                particlesContainer.appendChild(particle);
            }
        }

        // ============================================
        // PAGE TRANSITIONS
        // ============================================
        function showPage(pageId) {
            if (state.isTransitioning) return;
            state.isTransitioning = true;

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            setTimeout(() => {
                document.getElementById(pageId).classList.add('active');
                state.currentPage = pageId;
                state.isTransitioning = false;
            }, 400);
        }

        // ============================================
        // TYPEWRITER EFFECT
        // ============================================
        function typeWriter(text, elementId, callback) {
            const element = document.getElementById(elementId);
            let i = 0;
            element.textContent = '';

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    const delay = 50 + (Math.random() - 0.5) * 40;
                    setTimeout(type, delay);
                } else if (callback) {
                    setTimeout(callback, 400);
                }
            }
            type();
        }

        // ============================================
        // LANDING PAGE
        // ============================================
        if (isDesktop) {
            document.addEventListener('mousemove', (e) => {
                if (state.currentPage !== 'landing') return;

                const tama = landingTamagotchi;
                const rect = tama.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const deltaX = e.clientX - centerX;
                const tilt = Math.min(5, Math.max(-5, deltaX / 80));
                tama.style.transform = `rotate(${tilt}deg)`;

                const btnRect = continueBtn.getBoundingClientRect();
                const btnCenterX = btnRect.left + btnRect.width / 2;
                const btnCenterY = btnRect.top + btnRect.height / 2;
                const distance = Math.sqrt(
                    Math.pow(e.clientX - btnCenterX, 2) +
                    Math.pow(e.clientY - btnCenterY, 2)
                );

                if (distance < 150) {
                    tama.classList.remove('idle');
                    tama.classList.add('excited');
                    setTamagotchiState('landingTamaGrid', 'excited');
                } else {
                    tama.classList.remove('excited');
                    tama.classList.add('idle');
                    setTamagotchiState('landingTamaGrid', 'idle');
                }
            });
        }

        continueBtn.addEventListener('click', debounce(() => {
            landingTamagotchi.classList.remove('idle', 'excited');
            landingTamagotchi.classList.add('wave');

            setTimeout(() => {
                showPage('question');
                setTimeout(animateQuestionPage, 400);
                resetNoButton();
            }, 500);
        }));

        // ============================================
        // QUESTION PAGE
        // ============================================
        function animateQuestionPage() {
            const words = document.querySelectorAll('#questionText .word');
            words.forEach((word, i) => {
                setTimeout(() => word.classList.add('show'), i * 120);
            });

            setTimeout(() => {
                document.getElementById('buttonsContainer').classList.add('show');
            }, words.length * 120 + 300);
        }

        function handleYes() {
            showPage('cannon-transition');
            setTimeout(startCannonSequence, 400);
        }

        yesBtn.addEventListener('click', debounce(handleYes));

        function resetNoButton() {
            noBtn.style.position = 'relative';
            noBtn.style.left = 'auto';
            noBtn.style.top = 'auto';
        }

        function getRandomPosition() {
            const padding = 20;
            const btnWidth = noBtn.offsetWidth;
            const btnHeight = noBtn.offsetHeight;
            const yesRect = yesBtn.getBoundingClientRect();

            let x, y, attempts = 0;
            do {
                x = padding + Math.random() * (window.innerWidth - btnWidth - padding * 2);
                y = padding + Math.random() * (window.innerHeight - btnHeight - padding * 2);
                attempts++;
            } while (
                attempts < 50 &&
                Math.abs(x - yesRect.left) < 130 &&
                Math.abs(y - yesRect.top) < 80
            );

            return { x, y };
        }

        function showPopupTamagotchi(reaction) {
            const popup = popupTamagotchi;
            popup.className = 'popup-tamagotchi';
            setTamagotchiState('popupTamaGrid', 'sad');

            if (reaction === 'peek') popup.classList.add('peek');
            if (reaction === 'exclaim') popup.classList.add('show-exclaim');
            if (reaction === 'tear') popup.classList.add('show-tear');

            setTimeout(() => {
                popup.classList.add('show');
                if (reaction === 'wiggle') popup.classList.add('wiggle');
                if (reaction === 'droopy') popup.classList.add('droopy');

                const holdTime = reaction === 'droopy' ? 800 : reaction === 'peek' ? 300 : 600;
                setTimeout(() => {
                    popup.classList.remove('show', 'show-exclaim', 'show-tear');
                }, holdTime);
            }, 50);
        }

        noBtn.addEventListener('click', debounce(() => {
            if (state.noClickCount >= 4) return;

            state.noClickCount++;

            const currentRect = noBtn.getBoundingClientRect();
            if (noBtn.style.position !== 'fixed') {
                noBtn.style.position = 'fixed';
            }

            const newPos = getRandomPosition();
            let currentX = parseFloat(noBtn.style.left) || currentRect.left;
            let distance = Math.sqrt(Math.pow(newPos.x - currentX, 2));

            if (distance < 100) {
                newPos.x = (newPos.x + 120) % (window.innerWidth - noBtn.offsetWidth - 20);
            }

            noBtn.style.left = newPos.x + 'px';
            noBtn.style.top = newPos.y + 'px';

            const reactions = ['exclaim', 'wiggle', 'droopy', 'peek'];
            showPopupTamagotchi(reactions[state.noClickCount - 1]);

            if (state.noClickCount >= 4) {
                setTimeout(() => {
                    const questionContainer = document.getElementById('questionText');
                    questionContainer.style.transition = 'opacity 0.3s ease-out';
                    questionContainer.style.opacity = '0';

                    setTimeout(() => {
                        questionContainer.className = 'question-change-text';
                        questionContainer.innerHTML = 'Okay, you seem serious. Prove it.';
                        questionContainer.style.opacity = '1';

                        document.getElementById('buttonsContainer').style.opacity = '0';
                        noBtn.style.opacity = '0';

                        setTimeout(() => {
                            showPage('captcha');
                            setTimeout(initCaptcha, 400);
                        }, 800);
                    }, 300);
                }, 800);
            }
        }));

        // ============================================
        // CAPTCHA
        // ============================================
        const lachieImages = Array.from({length: 6}, (_, i) => ({
            id: `lachie-${i + 1}`,
            src: `assets/captcha/lachie-${i + 1}.jpg`,
            isLachie: true
        }));

        const stockImages = Array.from({length: 3}, (_, i) => ({
            id: `stock-${i + 1}`,
            src: `assets/captcha/stock-${i + 1}.jpg`,
            isLachie: false
        }));

        const rejectMessages = ['Not even close', 'Yeah... no', 'Who is this guy?', 'Absolutely not', 'Try again bestie'];

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function initCaptcha() {
            state.captchaSelections = [];
            const allImages = shuffleArray([...lachieImages, ...stockImages]);
            captchaGrid.innerHTML = '';

            allImages.forEach(img => {
                const polaroid = document.createElement('div');
                polaroid.className = 'polaroid';
                polaroid.style.transform = `rotate(${(Math.random() - 0.5) * 8}deg)`;
                polaroid.dataset.id = img.id;
                polaroid.dataset.isLachie = img.isLachie;

                const inner = document.createElement('div');
                inner.className = `polaroid-inner ${img.isLachie ? '' : 'stock'}`;

                const imgEl = document.createElement('img');
                imgEl.src = img.src;
                imgEl.alt = img.isLachie ? 'Photo' : 'Stock photo';
                imgEl.onerror = () => {
                    inner.style.background = img.isLachie ? 'linear-gradient(135deg, #E8657A, #D4506A)' : '#aaa';
                    inner.innerHTML = `<span style="color:white;font-size:11px;display:flex;align-items:center;justify-content:center;height:100%;">${img.isLachie ? 'Lachie' : 'Stock'}</span>`;
                };

                const checkmark = document.createElement('div');
                checkmark.className = 'checkmark';
                checkmark.textContent = '\u2713';

                inner.appendChild(imgEl);
                polaroid.appendChild(inner);
                polaroid.appendChild(checkmark);
                polaroid.addEventListener('click', () => handleCaptchaClick(polaroid, img));
                captchaGrid.appendChild(polaroid);
            });

            updateVerifyButton();
        }

        function handleCaptchaClick(polaroid, img) {
            if (!img.isLachie) {
                polaroid.classList.add('error');

                // Show rejection toast
                const toast = document.createElement('div');
                toast.className = 'rejection-toast';
                toast.textContent = rejectMessages[Math.floor(Math.random() * rejectMessages.length)];
                polaroid.appendChild(toast);

                setTimeout(() => {
                    polaroid.classList.remove('error', 'selected');
                    toast.remove();
                    state.captchaSelections = state.captchaSelections.filter(id => id !== img.id);
                    updateVerifyButton();
                }, 800);
                return;
            }

            if (polaroid.classList.contains('selected')) {
                polaroid.classList.remove('selected');
                state.captchaSelections = state.captchaSelections.filter(id => id !== img.id);
            } else {
                polaroid.classList.add('selected');
                polaroid.style.animation = 'none';
                polaroid.offsetHeight;
                polaroid.style.animation = 'selectPop 0.15s ease-out';
                state.captchaSelections.push(img.id);
            }

            updateVerifyButton();
        }

        function updateVerifyButton() {
            verifyBtn.disabled = state.captchaSelections.length === 0;
        }

        verifyBtn.addEventListener('click', debounce(() => {
            const hasLachie = state.captchaSelections.some(id => id.startsWith('lachie'));

            if (!hasLachie) {
                const message = document.getElementById('captchaMessage');
                message.textContent = 'Critical error: no husband material detected. Please try again.';
                message.classList.add('error');
                captchaGrid.style.display = 'none';
                verifyBtn.style.display = 'none';
                document.getElementById('captchaStatus').style.display = 'block';
                document.getElementById('captchaSpinner').style.display = 'none';

                setTimeout(() => {
                    state.captchaSelections = [];
                    document.querySelectorAll('.polaroid.selected').forEach(el => el.classList.remove('selected'));
                    captchaGrid.style.display = 'grid';
                    verifyBtn.style.display = 'block';
                    document.getElementById('captchaStatus').style.display = 'none';
                    message.classList.remove('error');
                    updateVerifyButton();
                }, 2000);
                return;
            }

            captchaGrid.style.display = 'none';
            verifyBtn.style.display = 'none';
            const status = document.getElementById('captchaStatus');
            const spinner = document.getElementById('captchaSpinner');
            const checkmark = document.getElementById('captchaCheckmark');
            const message = document.getElementById('captchaMessage');

            status.style.display = 'block';
            spinner.style.display = 'flex';
            message.textContent = 'Verifying...';

            setTimeout(() => {
                spinner.style.display = 'none';
                checkmark.style.display = 'block';
                message.textContent = 'Verification complete!';
                message.style.color = '#6DBF7B';

                setTimeout(() => {
                    checkmark.style.display = 'none';
                    message.textContent = "Hmm... looks like the No button is broken.";
                    message.style.color = '#3D2C2C';

                    const resultArea = document.getElementById('captchaResultArea');
                    const captchaYesBtn = document.getElementById('captchaYesBtn');
                    const captchaNoBroken = document.getElementById('captchaNoBroken');
                    const hint = document.getElementById('captchaHint');

                    resultArea.classList.add('show');
                    captchaYesBtn.style.display = 'inline-block';
                    captchaNoBroken.style.display = 'inline-block';

                    setTimeout(() => hint.classList.add('show'), 1500);

                    captchaYesBtn.addEventListener('click', debounce(handleYes));
                    captchaNoBroken.addEventListener('click', (e) => e.preventDefault());
                }, 1000);
            }, 1500);
        }));

        // ============================================
        // CANNON SEQUENCE
        // ============================================
        function startCannonSequence() {
            const cannon = document.getElementById('cannon');

            setTimeout(() => {
                cannon.classList.add('roll-in');

                setTimeout(() => {
                    document.body.classList.add('screen-shake');

                    setTimeout(() => {
                        document.body.classList.remove('screen-shake');

                        if (typeof confetti !== 'undefined') {
                            confetti({
                                particleCount: 250,
                                spread: 160,
                                origin: { x: 0.2, y: 0.85 },
                                colors: ['#E8657A', '#D4506A', '#FADADD', '#E8B86D', '#FFFFFF'],
                                gravity: 0.7,
                                ticks: 250,
                                shapes: ['square', 'circle'],
                                scalar: 1.2
                            });

                            setTimeout(() => {
                                confetti({
                                    particleCount: 150,
                                    spread: 120,
                                    origin: { x: 0.25, y: 0.8 },
                                    colors: ['#E8657A', '#E8B86D', '#FFFFFF'],
                                    gravity: 0.8,
                                    ticks: 200
                                });
                            }, 150);
                        }

                        setTimeout(() => {
                            showPage('iloveyou');
                            setTimeout(startLoveSequence, 400);
                        }, 500);
                    }, 200);
                }, 1300);
            }, 200);
        }

        // ============================================
        // I LOVE YOU SEQUENCE
        // ============================================
        function startLoveSequence() {
            const loveText = document.getElementById('loveText');
            const loveTooBtn = document.getElementById('loveTooBtn');

            loveText.classList.add('show');

            setTimeout(() => {
                loveTooBtn.classList.add('show');
            }, 1500);
        }

        document.getElementById('loveTooBtn').addEventListener('click', debounce(() => {
            const loveText = document.getElementById('loveText');
            const loveTooBtn = document.getElementById('loveTooBtn');

            loveTooBtn.classList.remove('show');
            loveTooBtn.style.display = 'none';

            setTimeout(() => {
                loveText.textContent = 'I love you three!';

                setTimeout(() => {
                    loveText.innerHTML = '<span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span><span class="ellipsis-dot">.</span>';
                    const dots = loveText.querySelectorAll('.ellipsis-dot');
                    dots.forEach((dot, i) => {
                        setTimeout(() => dot.classList.add('show'), i * 300);
                    });

                    setTimeout(() => {
                        document.getElementById('iloveyou').classList.remove('active');
                        document.getElementById('blackout').classList.add('active');
                        state.currentPage = 'blackout';

                        setTimeout(() => {
                            document.getElementById('blackout').classList.add('flicker');
                            setTimeout(() => {
                                document.getElementById('blackout').classList.remove('flicker');
                                startSixtySevenSequence();
                            }, 150);
                        }, 500);
                    }, 1100);
                }, 1000);
            }, 400);
        }));

        // ============================================
        // 67 SEQUENCE
        // ============================================
        function startSixtySevenSequence() {
            const text = document.getElementById('sixtysevenText');

            if (state.soundEnabled && audio67) {
                try {
                    audio67.currentTime = 0;
                    audio67.play().catch(() => {});
                } catch (e) {}
            }

            // Add rumble during animation
            document.body.classList.add('screen-rumble');
            text.classList.add('slide');

            setTimeout(() => {
                document.body.classList.remove('screen-rumble');

                setTimeout(() => {
                    const blackout = document.getElementById('blackout');
                    blackout.style.transition = 'opacity 1s ease-out';
                    blackout.style.opacity = '0';

                    setTimeout(() => {
                        blackout.classList.remove('active');
                        blackout.style.opacity = '';
                        blackout.style.transition = '';
                        showPage('victory');
                        setTimeout(startVictorySequence, 400);
                    }, 1000);
                }, 500);
            }, 2000);
        }

        // ============================================
        // VICTORY SEQUENCE
        // ============================================
        function startVictorySequence() {
            setTamagotchiState('victoryTamaGrid', 'excited');

            const heartsDiv = document.getElementById('victoryHearts');
            for (let i = 0; i < 4; i++) {
                const heart = document.createElement('span');
                heart.className = 'victory-heart';
                heart.textContent = '\u2764';
                heart.style.left = `${15 + i * 25}%`;
                heart.style.animationDelay = `${i * 0.4}s`;
                heartsDiv.appendChild(heart);
            }

            function miniBurst() {
                if (state.currentPage !== 'victory') return;
                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 18,
                        spread: 50,
                        origin: { x: 0.2 + Math.random() * 0.6, y: 0.3 },
                        colors: ['#E8657A', '#E8B86D', '#FFFFFF'],
                        gravity: 0.5,
                        ticks: 120
                    });
                }
                setTimeout(miniBurst, 4000);
            }
            setTimeout(miniBurst, 2000);

            const lines = document.querySelectorAll('.victory-line');
            lines.forEach((line, i) => {
                setTimeout(() => line.classList.add('show'), i * 250);
            });
        }

        // ============================================
        // CALENDAR DOWNLOAD
        // ============================================
        document.getElementById('calendarLink').addEventListener('click', (e) => {
            e.preventDefault();

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Valentine//EN
BEGIN:VEVENT
DTSTART:20260214T100000
DTEND:20260214T180000
SUMMARY:Valentine's Day Date
DESCRIPTION:Recreating our first date + surprises
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'valentines-date.ics';
            a.click();
            URL.revokeObjectURL(url);
        });

        // ============================================
        // RESIZE HANDLER
        // ============================================
        window.addEventListener('resize', () => {
            createParticles();

            if (state.currentPage === 'question' && noBtn.style.position === 'fixed') {
                const rect = noBtn.getBoundingClientRect();
                if (rect.right > window.innerWidth || rect.bottom > window.innerHeight) {
                    const newPos = getRandomPosition();
                    noBtn.style.left = newPos.x + 'px';
                    noBtn.style.top = newPos.y + 'px';
                }
            }
        });

        // ============================================
        // INITIALIZE
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            updateSoundIcon();
            createParticles();
            preloadAssets();

            setTamagotchiState('landingTamaGrid', 'idle');
            setTamagotchiState('popupTamaGrid', 'sad');
            setTamagotchiState('victoryTamaGrid', 'excited');
            renderPixelGrid(document.getElementById('cannonGrid'), cannonData, cannonColorMap);

            setTimeout(() => {
                typeWriter("hey beautiful, i made something for you...", "typewriterText", () => {
                    continueBtn.style.opacity = '1';
                    continueBtn.style.transition = 'opacity 0.5s ease-out';
                });
            }, 500);
        });

        // Select pop animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes selectPop {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
