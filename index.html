<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>For You</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=DM+Sans:wght@400;500;700&family=Dela+Gothic+One&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

  <!-- Confetti CDN -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    /* ========================================
       CSS RESET & BASE
    ======================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: #FFF8F0;
      color: #3D2C2C;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================
       CSS VARIABLES
    ======================================== */
    :root {
      /* Backgrounds */
      --bg-cream: #FFF8F0;
      --bg-blush: #FFF0F3;
      --bg-white: #FFFFFF;
      --bg-black: #000000;

      /* Text */
      --text-primary: #3D2C2C;
      --text-secondary: #7A6565;
      --text-muted: #9B8A8A;

      /* Accents */
      --rose: #E8657A;
      --rose-hover: #D4506A;
      --rose-light: #FADADD;
      --rose-glow: rgba(232, 101, 122, 0.15);
      --gold: #E8B86D;
      --red-error: #E74C3C;
      --green-success: #6DBF7B;

      /* Button */
      --btn-secondary-bg: #F5E6E8;
      --btn-secondary-hover: #EDD5D8;
    }

    /* ========================================
       CUSTOM CURSOR (Desktop Only)
    ======================================== */
    @media (hover: hover) and (pointer: fine) {
      body:not(.blackout) {
        cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18'%3E%3Cpath d='M9 3 C6 0, 0 2, 0 7 C0 12, 9 17, 9 17 C9 17, 18 12, 18 7 C18 2, 12 0, 9 3Z' fill='%23E8657A'/%3E%3C/svg%3E") 9 9, auto;
      }

      body:not(.blackout) * {
        cursor: inherit;
      }

      button, .btn, [role="button"] {
        cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 18 18'%3E%3Cpath d='M9 3 C6 0, 0 2, 0 7 C0 12, 9 17, 9 17 C9 17, 18 12, 18 7 C18 2, 12 0, 9 3Z' fill='%23E8657A'/%3E%3C/svg%3E") 9 9, pointer;
      }
    }

    /* ========================================
       BACKGROUND GRADIENT ANIMATION
    ======================================== */
    @keyframes bgShift {
      0%, 100% { background-color: #FFF8F0; }
      50% { background-color: #FFF2F0; }
    }

    body {
      animation: bgShift 20s ease-in-out infinite;
    }

    body.blackout {
      animation: none !important;
      background-color: #000000 !important;
    }

    /* ========================================
       PARTICLE LAYER
    ======================================== */
    #particle-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
      transition: opacity 0.3s;
    }

    .particle {
      position: absolute;
      bottom: -30px;
      will-change: transform, opacity;
    }

    .particle-heart {
      width: 12px;
      height: 12px;
      opacity: 0.25;
    }

    .particle-heart::before {
      content: '';
      display: block;
      width: 100%;
      height: 100%;
      background: var(--rose);
      clip-path: path('M6 2 C4 0, 0 1, 0 4 C0 7, 6 10, 6 10 C6 10, 12 7, 12 4 C12 1, 8 0, 6 2Z');
    }

    .particle-sparkle {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--gold);
      opacity: 0.25;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) translateX(0) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: var(--particle-opacity, 0.25);
      }
      90% {
        opacity: var(--particle-opacity, 0.25);
      }
      100% {
        transform: translateY(calc(-100vh - 50px)) translateX(var(--drift, 0px)) rotate(var(--rotation, 0deg));
        opacity: 0;
      }
    }

    /* ========================================
       SPARKLE TRAIL (Desktop Only)
    ======================================== */
    .sparkle-trail {
      position: fixed;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      animation: sparkleOut 0.3s ease-out forwards;
    }

    @keyframes sparkleOut {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }

    /* ========================================
       SOUND TOGGLE
    ======================================== */
    #sound-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(61, 44, 44, 0.05);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 10000;
      transition: background 0.2s;
      cursor: pointer;
    }

    #sound-toggle:hover {
      background: rgba(61, 44, 44, 0.1);
    }

    body.blackout #sound-toggle {
      background: rgba(255, 255, 255, 0.1);
    }

    body.blackout #sound-toggle:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* ========================================
       PAGE CONTAINERS
    ======================================== */
    .page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1;
      padding: 20px;
    }

    .page.active {
      display: flex;
    }

    .page-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      max-width: 100%;
    }

    /* Page transition animations */
    @keyframes pageIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pageOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    .page.entering {
      animation: pageIn 0.4s ease-out forwards;
    }

    .page.exiting {
      animation: pageOut 0.4s ease-out forwards;
    }

    /* ========================================
       BUTTONS
    ======================================== */
    .btn {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: 16px;
      border: none;
      border-radius: 50px;
      padding: 14px 40px;
      min-width: 130px;
      min-height: 48px;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: var(--rose);
      color: #FFFFFF;
      box-shadow: 0 3px 10px rgba(232, 101, 122, 0.3);
    }

    .btn-primary:hover {
      background: var(--rose-hover);
      box-shadow: 0 6px 20px rgba(232, 101, 122, 0.4);
      transform: scale(1.03);
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary:disabled:hover {
      background: var(--rose);
      box-shadow: 0 3px 10px rgba(232, 101, 122, 0.3);
      transform: none;
    }

    .btn-secondary {
      background: var(--btn-secondary-bg);
      color: var(--text-primary);
      box-shadow: 0 1px 4px rgba(61, 44, 44, 0.06);
    }

    .btn-secondary:hover {
      background: var(--btn-secondary-hover);
    }

    @keyframes btnPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.015); }
    }

    .btn-pulse {
      animation: btnPulse 3s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      14% { transform: scale(1.04); }
      28% { transform: scale(1); }
      42% { transform: scale(1.07); }
      56% { transform: scale(1); }
    }

    .btn-heartbeat {
      animation: heartbeat 0.9s ease-in-out infinite;
    }

    /* ========================================
       TAMAGOTCHI PIXEL ART
    ======================================== */
    .tamagotchi-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 40px 20px var(--rose-glow);
      border-radius: 50%;
    }

    .tamagotchi {
      display: grid;
      grid-template-columns: repeat(16, 1fr);
      grid-template-rows: repeat(16, 1fr);
      width: 96px;
      height: 96px;
      image-rendering: pixelated;
    }

    .tamagotchi .pixel {
      width: 100%;
      height: 100%;
    }

    /* Tamagotchi colors */
    .px-body { background: #FFF176; }
    .px-ear { background: #1A237E; }
    .px-eye { background: #1A237E; }
    .px-eye-highlight { background: #FFFFFF; }
    .px-cheek { background: #F48FB1; }
    .px-mouth { background: #D32F2F; }
    .px-outline { background: #333333; }
    .px-tear { background: #64B5F6; }
    .px-heart { background: #E8657A; }

    @keyframes tamaFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .tamagotchi-wrapper.floating {
      animation: tamaFloat 2.5s ease-in-out infinite;
    }

    @keyframes tamaWave {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(-8deg); }
      50% { transform: rotate(8deg); }
      75% { transform: rotate(-8deg); }
      100% { transform: rotate(0deg); }
    }

    .tamagotchi-wrapper.waving {
      animation: tamaWave 0.5s ease-in-out;
    }

    @keyframes tamaBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.12); }
    }

    .tamagotchi-wrapper.bouncing {
      animation: tamaBounce 0.3s ease-out;
    }

    @keyframes tamaEnergeticBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .tamagotchi-wrapper.energetic {
      animation: tamaEnergeticBounce 1s ease-in-out infinite;
    }

    /* ========================================
       TAMAGOTCHI PEEK CONTAINER
    ======================================== */
    #tama-peek-container {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 80px;
      overflow: hidden;
      z-index: 100;
      pointer-events: none;
      display: none;
    }

    #tama-peek-container .tamagotchi-wrapper {
      position: absolute;
      top: -120px;
      left: 50%;
      transform: translateX(-50%);
      transition: top 0.4s ease-out;
      box-shadow: none;
    }

    #tama-peek-container .peek-text {
      position: absolute;
      font-family: 'DM Sans', sans-serif;
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
      left: 100%;
      top: 40px;
      margin-left: 8px;
    }

    #tama-peek-container .peek-exclaim {
      position: absolute;
      font-size: 14px;
      font-weight: bold;
      color: #FF5722;
      opacity: 0;
      transition: opacity 0.2s;
      left: 100%;
      top: 30px;
      margin-left: 8px;
    }

    /* ========================================
       PIXEL HEARTS (Decorative & Floating)
    ======================================== */
    .pixel-heart-deco {
      position: absolute;
      width: 30px;
      height: 30px;
      opacity: 0.25;
      pointer-events: none;
    }

    .pixel-heart-deco::before {
      content: '';
      display: block;
      width: 100%;
      height: 100%;
      background: var(--rose-light);
      clip-path: path('M15 5 C10 0, 0 3, 0 10 C0 17, 15 25, 15 25 C15 25, 30 17, 30 10 C30 3, 20 0, 15 5Z');
    }

    .floating-pixel-heart {
      position: absolute;
      width: 10px;
      height: 10px;
      pointer-events: none;
    }

    .floating-pixel-heart::before {
      content: '';
      display: block;
      width: 100%;
      height: 100%;
      background: var(--rose);
      clip-path: path('M5 1.5 C3.5 0, 0 1, 0 3.5 C0 6, 5 8.5, 5 8.5 C5 8.5, 10 6, 10 3.5 C10 1, 6.5 0, 5 1.5Z');
    }

    @keyframes floatHeartUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-60px) scale(0.5);
        opacity: 0;
      }
    }

    .floating-pixel-heart.animate {
      animation: floatHeartUp 1.5s ease-out forwards;
    }

    /* ========================================
       CANNON PIXEL ART
    ======================================== */
    #cannon {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      grid-template-rows: repeat(16, 1fr);
      width: 180px;
      height: 120px;
      image-rendering: pixelated;
      position: absolute;
    }

    #cannon .pixel {
      width: 100%;
      height: 100%;
    }

    .px-barrel { background: #37474F; }
    .px-barrel-shadow { background: #263238; }
    .px-barrel-highlight { background: #546E7A; }
    .px-base { background: #5D4037; }
    .px-base-shadow { background: #3E2723; }
    .px-wheel { background: #263238; }
    .px-wheel-hub { background: #455A64; }

    @keyframes cannonEnter {
      0% {
        transform: translateX(-200px);
      }
      85% {
        transform: translateX(6px);
      }
      100% {
        transform: translateX(0);
      }
    }

    @keyframes screenShake {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-4px, 2px); }
      20% { transform: translate(3px, -3px); }
      30% { transform: translate(-2px, 4px); }
      40% { transform: translate(4px, -2px); }
      50% { transform: translate(-3px, 3px); }
    }

    body.shaking {
      animation: screenShake 0.25s ease-out;
    }

    /* ========================================
       PAGE 1: LANDING
    ======================================== */
    #landing .typewriter-text {
      font-family: 'Caveat', cursive;
      font-weight: 700;
      font-size: clamp(24px, 5vw, 32px);
      color: var(--text-primary);
      margin: 24px 0 32px;
      min-height: 1.4em;
    }

    #landing .typewriter-cursor {
      animation: blink 0.8s step-end infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    #landing .nudge-text {
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 60px;
    }

    #landing .continue-btn {
      padding: 14px 48px;
    }

    /* ========================================
       PAGE 2: QUESTION
    ======================================== */
    #question {
      position: relative;
    }

    #question .question-text {
      font-family: 'Playfair Display', serif;
      font-weight: 900;
      font-size: clamp(32px, 8vw, 56px);
      color: var(--text-primary);
      letter-spacing: 0.02em;
      margin-bottom: 12px;
    }

    #question .question-text .word {
      display: inline-block;
      opacity: 0;
      transform: translateY(10px);
    }

    @keyframes wordReveal {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #question .subtitle {
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 32px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #question .subtitle.visible {
      opacity: 1;
    }

    #question .button-row {
      display: flex;
      gap: 16px;
      opacity: 0;
      transition: opacity 0.4s;
    }

    #question .button-row.visible {
      opacity: 1;
    }

    #question .no-btn {
      transition: all 180ms cubic-bezier(0.2, 0, 0, 1);
    }

    /* Decorative hearts */
    #question .deco-heart-1 {
      top: 20%;
      left: 15%;
      transform: rotate(-15deg);
    }

    #question .deco-heart-2 {
      bottom: 25%;
      right: 15%;
      transform: rotate(20deg);
    }

    @keyframes textWobble {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-1deg); }
      75% { transform: rotate(1deg); }
    }

    #question .question-text.wobbling {
      animation: textWobble 0.3s ease-in-out infinite;
    }

    /* Transition text */
    #question .transition-text {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: clamp(16px, 4vw, 20px);
      color: var(--text-secondary);
      opacity: 0;
      transition: opacity 0.4s;
    }

    #question .transition-text.visible {
      opacity: 1;
    }

    /* ========================================
       PAGE 3: CAPTCHA
    ======================================== */
    #captcha {
      background: var(--bg-blush);
    }

    #captcha .header-text {
      text-align: center;
      margin-bottom: 24px;
    }

    #captcha .header-text h2 {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: clamp(20px, 4vw, 28px);
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    #captcha .header-text p {
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--text-secondary);
      opacity: 0;
      transition: opacity 0.3s;
    }

    #captcha .header-text p.visible {
      opacity: 1;
    }

    #captcha .captcha-container {
      background: var(--bg-white);
      border: 1px solid rgba(61, 44, 44, 0.08);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(61, 44, 44, 0.07);
      max-width: 440px;
      width: 100%;
      overflow: hidden;
    }

    #captcha .captcha-header {
      background: var(--rose);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 12px 12px 0 0;
    }

    #captcha .captcha-header span {
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      color: white;
      font-weight: 500;
    }

    #captcha .captcha-header .shield {
      width: 20px;
      height: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    #captcha .captcha-body {
      padding: 20px;
    }

    #captcha .captcha-prompt {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-align: left;
    }

    #captcha .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    #captcha .polaroid {
      position: relative;
      background: white;
      padding: 6px 6px 22px 6px;
      border: 1px solid rgba(61, 44, 44, 0.05);
      box-shadow: 0 2px 6px rgba(61, 44, 44, 0.08);
      border-radius: 3px;
      transition: all 0.2s ease-out;
      cursor: pointer;
    }

    #captcha .polaroid .photo-inner {
      aspect-ratio: 1;
      overflow: hidden;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #captcha .polaroid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #captcha .polaroid.stock img {
      filter: saturate(0.8) brightness(0.97);
    }

    #captcha .polaroid:hover {
      transform: rotate(0deg) translateY(-3px) scale(1.03) !important;
      box-shadow: 0 4px 12px rgba(61, 44, 44, 0.14);
    }

    #captcha .polaroid.selected {
      border: 2px solid var(--rose);
    }

    @keyframes selectPop {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    #captcha .polaroid.popping {
      animation: selectPop 0.15s ease-out;
    }

    #captcha .polaroid .checkmark {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: var(--rose);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    #captcha .polaroid.selected .checkmark {
      display: flex;
    }

    @keyframes flashRed {
      0%, 100% { border-color: rgba(61, 44, 44, 0.05); }
      50% { border-color: var(--red-error); }
    }

    #captcha .polaroid.rejected {
      animation: flashRed 0.3s ease;
    }

    #captcha .toast {
      position: absolute;
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      color: var(--red-error);
      text-shadow: 0 1px 2px rgba(0,0,0,0.08);
      white-space: nowrap;
      pointer-events: none;
      z-index: 10;
      left: 50%;
      top: 50%;
      transform: translateX(-50%);
    }

    @keyframes toastUp {
      0% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateX(-50%) translateY(-25px);
      }
    }

    #captcha .verify-btn {
      width: 100%;
    }

    /* CAPTCHA Loading */
    #captcha .loading-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      height: 100px;
    }

    #captcha .loading-dots .dot {
      width: 8px;
      height: 8px;
      background: var(--rose);
      border-radius: 50%;
      animation: dotBounce 0.6s ease-in-out infinite;
    }

    #captcha .loading-dots .dot:nth-child(2) {
      animation-delay: 0.15s;
    }

    #captcha .loading-dots .dot:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes dotBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* CAPTCHA Success */
    #captcha .success-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
    }

    #captcha .success-message .checkmark-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--green-success);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #captcha .success-message .check-icon {
      width: 24px;
      height: 24px;
      stroke: white;
      stroke-width: 3;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    #captcha .success-message span {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      color: var(--green-success);
    }

    /* Post-CAPTCHA state */
    #captcha .post-captcha {
      text-align: center;
    }

    #captcha .post-captcha .broken-text {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    #captcha .post-captcha .button-row {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-bottom: 16px;
    }

    #captcha .post-captcha .broken-no {
      transform: rotate(3deg);
      opacity: 0.4;
      filter: grayscale(0.5);
      cursor: not-allowed;
      position: relative;
      pointer-events: none;
    }

    #captcha .post-captcha .broken-no::after {
      content: '';
      position: absolute;
      top: 30%;
      left: 20%;
      width: 60%;
      height: 1px;
      background: rgba(61, 44, 44, 0.4);
      transform: rotate(30deg);
    }

    #captcha .post-captcha .nudge {
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--text-muted);
      opacity: 0;
      transition: opacity 0.4s;
    }

    #captcha .post-captcha .nudge.visible {
      opacity: 1;
    }

    /* Error state */
    #captcha .error-message {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      color: var(--red-error);
      text-align: center;
      padding: 20px;
    }

    /* ========================================
       PAGE 5: CANNON TRANSITION
    ======================================== */
    #cannon-page {
      background: var(--bg-white);
    }

    /* ========================================
       PAGE 6: I LOVE YOU
    ======================================== */
    #iloveyou .love-text {
      font-family: 'Playfair Display', serif;
      font-weight: 900;
      font-size: clamp(36px, 8vw, 64px);
      color: var(--text-primary);
      text-shadow: 0 2px 4px rgba(232, 101, 122, 0.1);
      opacity: 0;
      transform: scale(0.96);
      transition: all 1s ease-out;
    }

    #iloveyou .love-text.visible {
      opacity: 1;
      transform: scale(1);
    }

    #iloveyou .love-btn {
      margin-top: 32px;
      opacity: 0;
      transition: opacity 0.4s;
    }

    #iloveyou .love-btn.visible {
      opacity: 1;
    }

    #iloveyou .ellipsis {
      font-family: 'Playfair Display', serif;
      font-weight: 900;
      font-size: clamp(36px, 8vw, 64px);
      color: var(--text-primary);
    }

    #iloveyou .ellipsis .dot {
      opacity: 0;
      transition: opacity 0.2s;
    }

    #iloveyou .ellipsis .dot.visible {
      opacity: 1;
    }

    /* ========================================
       BLACKOUT & 67 SEQUENCE
    ======================================== */
    #blackout-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      z-index: 9998;
      display: none;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #blackout-overlay.active {
      display: flex;
    }

    @keyframes flicker {
      0% { opacity: 1; }
      20% { opacity: 0; }
      40% { opacity: 1; }
      60% { opacity: 0.4; }
      100% { opacity: 1; }
    }

    #blackout-overlay.flickering {
      animation: flicker 0.2s ease-out;
    }

    #blackout-overlay .sixty-seven {
      font-family: 'Dela Gothic One', sans-serif;
      font-size: clamp(44px, 16vw, 140px);
      color: white;
      text-shadow: 0 0 30px rgba(255,255,255,0.4), 0 0 60px rgba(232,101,122,0.2);
      white-space: nowrap;
      position: absolute;
      transform: translateX(100vw);
    }

    @keyframes slide67 {
      0% { transform: translateX(100vw); }
      25% { transform: translateX(0); }
      75% { transform: translateX(0); }
      100% { transform: translateX(-100vw); }
    }

    #blackout-overlay .sixty-seven.sliding {
      animation: slide67 2.5s cubic-bezier(0.22, 0, 0.36, 1) forwards;
    }

    @keyframes rumble {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-2px, 1px); }
      20% { transform: translate(1px, -2px); }
      30% { transform: translate(-1px, 2px); }
      40% { transform: translate(2px, -1px); }
      50% { transform: translate(-2px, -1px); }
      60% { transform: translate(1px, 2px); }
      70% { transform: translate(-1px, -2px); }
      80% { transform: translate(2px, 1px); }
      90% { transform: translate(-1px, 1px); }
    }

    body.rumbling {
      animation: rumble 0.1s linear infinite;
    }

    /* ========================================
       PAGE 7: VICTORY
    ======================================== */
    #victory {
      background: var(--bg-blush);
    }

    #victory .victory-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    #victory .victory-content > * {
      opacity: 0;
      transform: translateY(15px);
    }

    @keyframes victoryReveal {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #victory .tamagotchi-section {
      position: relative;
      margin-bottom: 24px;
    }

    #victory .its-a-date {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: clamp(28px, 5vw, 42px);
      color: var(--rose);
      margin-bottom: 16px;
    }

    #victory .date-line {
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: clamp(16px, 3vw, 20px);
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    #victory .time-line {
      font-family: 'DM Sans', sans-serif;
      font-weight: 400;
      font-size: clamp(14px, 2.5vw, 18px);
      color: var(--text-primary);
      margin-bottom: 20px;
    }

    #victory .recreating {
      font-family: 'Caveat', cursive;
      font-weight: 700;
      font-size: clamp(18px, 3.5vw, 24px);
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    #victory .surprises {
      font-family: 'Caveat', cursive;
      font-weight: 700;
      font-size: clamp(15px, 3vw, 20px);
      color: var(--rose);
      opacity: 0.65;
      margin-bottom: 24px;
    }

    #victory .calendar-btn {
      background: var(--btn-secondary-bg);
      color: var(--rose);
      font-family: 'DM Sans', sans-serif;
      font-weight: 400;
      font-size: 14px;
      padding: 10px 24px;
      border: 1px solid rgba(232, 101, 122, 0.15);
      border-radius: 50px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #victory .calendar-btn:hover {
      background: var(--btn-secondary-hover);
    }

    #victory .footer {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ========================================
       RESPONSIVE
    ======================================== */
    @media (max-width: 480px) {
      #captcha .captcha-body {
        padding: 16px;
      }

      #captcha .polaroid {
        padding: 4px 4px 16px 4px;
      }

      #tama-peek-container {
        width: 100px;
        height: 70px;
      }

      .btn {
        min-height: 48px;
        min-width: 44px;
      }
    }
  </style>
</head>
<body>
  <!-- Sound Toggle -->
  <button id="sound-toggle" aria-label="Toggle sound">
    <span class="sound-icon">üîä</span>
  </button>

  <!-- Particle Layer -->
  <div id="particle-layer"></div>

  <!-- Tamagotchi Peek Container (for Question page) -->
  <div id="tama-peek-container">
    <div class="tamagotchi-wrapper" id="peek-tama"></div>
    <span class="peek-text" id="peek-text"></span>
    <span class="peek-exclaim" id="peek-exclaim">!</span>
  </div>

  <!-- Blackout Overlay -->
  <div id="blackout-overlay">
    <span class="sixty-seven">SIIIIIXXX SEVVENNNNNN</span>
  </div>

  <!-- PAGE 1: Landing -->
  <div id="landing" class="page active">
    <div class="page-content">
      <div class="tamagotchi-wrapper floating" id="landing-tama">
        <!-- Tamagotchi will be rendered by JS -->
      </div>
      <div class="typewriter-text" id="typewriter">
        <span id="typewriter-content"></span><span class="typewriter-cursor">|</span>
      </div>
      <button class="btn btn-primary btn-pulse continue-btn" id="continue-btn">Continue</button>
      <p class="nudge-text">tap continue, i promise it's worth it</p>
    </div>
  </div>

  <!-- PAGE 2: Question -->
  <div id="question" class="page">
    <div class="pixel-heart-deco deco-heart-1"></div>
    <div class="pixel-heart-deco deco-heart-2"></div>
    <div class="page-content" id="question-content">
      <h1 class="question-text" id="question-text">
        <span class="word">Will</span>
        <span class="word">you</span>
        <span class="word">be</span>
        <span class="word">my</span>
        <span class="word">Valentine?</span>
      </h1>
      <p class="subtitle" id="question-subtitle">(choose wisely)</p>
      <div class="button-row" id="question-buttons">
        <button class="btn btn-primary yes-btn" id="yes-btn-question">Yes</button>
        <button class="btn btn-secondary no-btn" id="no-btn">No</button>
      </div>
      <p class="transition-text" id="transition-text">Okay, you seem serious. Prove it.</p>
    </div>
  </div>

  <!-- PAGE 3: CAPTCHA -->
  <div id="captcha" class="page">
    <div class="page-content">
      <div class="header-text">
        <h2>One more thing...</h2>
        <p id="captcha-subheader">Complete this security check to continue</p>
      </div>
      <div class="captcha-container" id="captcha-container">
        <div class="captcha-header">
          <span>reCAPTCHA</span>
          <div class="shield">üõ°Ô∏è</div>
        </div>
        <div class="captcha-body" id="captcha-body">
          <p class="captcha-prompt">Select all images containing husband material</p>
          <div class="photo-grid" id="photo-grid">
            <!-- Photos rendered by JS -->
          </div>
          <button class="btn btn-primary verify-btn" id="verify-btn" disabled>Verify</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGE 5: Cannon -->
  <div id="cannon-page" class="page">
    <div id="cannon">
      <!-- Cannon pixel art rendered by JS -->
    </div>
  </div>

  <!-- PAGE 6: I Love You -->
  <div id="iloveyou" class="page">
    <div class="page-content">
      <h1 class="love-text" id="love-text">I love you</h1>
      <div class="ellipsis" id="ellipsis" style="display: none;">
        <span class="dot">.</span>
        <span class="dot">.</span>
        <span class="dot">.</span>
      </div>
      <button class="btn btn-primary btn-heartbeat love-btn" id="love-btn">I love you too!</button>
    </div>
  </div>

  <!-- PAGE 7: Victory -->
  <div id="victory" class="page">
    <div class="victory-content">
      <div class="tamagotchi-section">
        <div class="tamagotchi-wrapper energetic" id="victory-tama">
          <!-- Tamagotchi rendered by JS -->
        </div>
      </div>
      <h1 class="its-a-date">It's a date.</h1>
      <p class="date-line">Saturday, February 14th</p>
      <p class="time-line">10:00 AM</p>
      <p class="recreating">We're recreating our first date.</p>
      <p class="surprises">(plus a few surprises)</p>
      <button class="calendar-btn" id="calendar-btn">Add to Calendar</button>
    </div>
    <p class="footer">made with way too much effort and a little help from AI</p>
  </div>

  <!-- Audio -->
  <audio id="audio-67" preload="auto">
    <source src="assets/67-audio.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ========================================
    // STATE
    // ========================================
    const state = {
      currentPage: 'landing',
      noClickCount: 0,
      captchaSelections: [],
      soundEnabled: true,
      transitioning: false,
      lastClickTime: 0
    };

    // ========================================
    // DEBOUNCE
    // ========================================
    function debounce(delay = 200) {
      const now = Date.now();
      if (now - state.lastClickTime < delay) return false;
      state.lastClickTime = now;
      return true;
    }

    // ========================================
    // TAMAGOTCHI PIXEL ART
    // ========================================
    // 16x16 grid, character codes:
    // _ = empty, B = body (yellow), E = ear/outline (navy), W = eye (navy),
    // H = highlight (white), C = cheek (pink), M = mouth (red), T = tear (blue)
    const TAMA_IDLE = [
      '____EEEEEEEE____',
      '___EEEEEEEEEE___',
      '__EEBBBBBBBBEE__',
      '_EBBBBBBBBBBBBE_',
      '_EBBWWHBBWWHBBE_',
      '_EBBWHBBBBWHBBE_',
      '_ECBBBBBBBBBBCE_',
      '_EBBBBBBBBBBBBE_',
      '_EBBBBMMMMBBBBE_',
      '_EBBBBBBBBBBBBE_',
      '__EBBBBBBBBBBER_',
      '__EEBBBBBBBBEE__',
      '___EEBBBBBBEEE__',
      '____EEBBBBEE____',
      '_____EEBBEEE____',
      '______EEEE______'
    ];

    const TAMA_EXCITED = [
      '___HH______HH___',
      '__HHHH____HHHH__',
      '____EEEEEEEE____',
      '___EEEEEEEEEE___',
      '__EEBBBBBBBBEE__',
      '_EBBBBBBBBBBBBE_',
      '_EBBEEBBBBEEBBE_',
      '_ECBBBBBBBBBBCE_',
      '_EBBBBMMMMBBBE_R',
      'REBBBBBBBBBBBBER',
      '__EBBBBBBBBBE___',
      '__EEBBBBBBBBEE__',
      '___EEBBBBBBEE___',
      '____EEBBBBEE____',
      '_____EEBBEEE____',
      '______EEEE______'
    ];

    const TAMA_SAD = [
      '____EEEEEEEE____',
      '___EEEEEEEEEE___',
      '__EEBBBBBBBBEE__',
      '_EBBBBBBBBBBBBE_',
      '_EBBBBBBBBBBBBE_',
      '_EBBEEBBBBEEBBE_',
      '_ECBWWHBBBBWHCE_',
      '_EBBBBBBBBBBBET_',
      '_EBBBBBBBBBBBBE_',
      '_EBBBBNNNNBBBBE_',
      '__EBBBBBBBBBBE__',
      '__EEBBBBBBBBEE__',
      '___EEBBBBBBEE___',
      '____EBBBBBBE____',
      '_____EBBBBEE____',
      '______EEEE______'
    ];

    const TAMA_COLORS = {
      'B': 'px-body',
      'E': 'px-ear',
      'W': 'px-eye',
      'H': 'px-eye-highlight',
      'C': 'px-cheek',
      'M': 'px-mouth',
      'N': 'px-mouth',
      'R': 'px-body',
      'T': 'px-tear',
      '_': ''
    };

    function renderTamagotchi(container, sprite) {
      container.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'tamagotchi';

      for (let row of sprite) {
        for (let char of row) {
          const pixel = document.createElement('div');
          pixel.className = 'pixel';
          if (TAMA_COLORS[char]) {
            pixel.classList.add(TAMA_COLORS[char]);
          }
          grid.appendChild(pixel);
        }
      }
      container.appendChild(grid);
    }

    // ========================================
    // CANNON PIXEL ART
    // ========================================
    const CANNON_SPRITE = [
      '________________________',
      '________________________',
      '____________HHHH________',
      '___________HBBBBH_______',
      '__________HBBBBBSH______',
      '_________HBBBBBBSSH_____',
      '________HBBBBBBBSSH_____',
      '_______HBBBBBBBBSSH_____',
      '______HBBBBBBBBBSS______',
      '______DDDDDDDDDDD_______',
      '_____DDDDDDDDDDDD_______',
      '_____DDDSSSDDDDDDD______',
      '____WWWW____WWWW________',
      '___WCCWW____WCCWW_______',
      '___WWWWW____WWWWW_______',
      '____WWW______WWW________'
    ];

    const CANNON_COLORS = {
      'B': 'px-barrel',
      'S': 'px-barrel-shadow',
      'H': 'px-barrel-highlight',
      'D': 'px-base',
      'W': 'px-wheel',
      'C': 'px-wheel-hub',
      '_': ''
    };

    function renderCannon(container) {
      container.innerHTML = '';

      for (let row of CANNON_SPRITE) {
        for (let char of row) {
          const pixel = document.createElement('div');
          pixel.className = 'pixel';
          if (CANNON_COLORS[char]) {
            pixel.classList.add(CANNON_COLORS[char]);
          }
          container.appendChild(pixel);
        }
      }
    }

    // ========================================
    // PARTICLE SYSTEM
    // ========================================
    function createParticles() {
      const layer = document.getElementById('particle-layer');
      layer.innerHTML = '';
      const isMobile = window.innerWidth < 768;
      const particleCount = isMobile ? 8 : 14;

      for (let i = 0; i < particleCount; i++) {
        const isHeart = i < (isMobile ? 4 : 7);
        const particle = document.createElement('div');
        particle.className = `particle ${isHeart ? 'particle-heart' : 'particle-sparkle'}`;

        const size = isHeart ? (8 + Math.random() * 4) : (3 + Math.random() * 2);
        const opacity = 0.15 + Math.random() * 0.2;
        const duration = 10 + Math.random() * 5;
        const delay = Math.random() * duration;
        const startX = Math.random() * 100;
        const drift = -40 + Math.random() * 80;
        const rotation = isHeart ? (-20 + Math.random() * 40) : 0;

        particle.style.cssText = `
          left: ${startX}%;
          width: ${size}px;
          height: ${size}px;
          --particle-opacity: ${opacity};
          --drift: ${drift}px;
          --rotation: ${rotation}deg;
          animation: floatUp ${duration}s linear ${delay}s infinite;
        `;

        layer.appendChild(particle);
      }
    }

    // ========================================
    // SPARKLE TRAIL (Desktop Only)
    // ========================================
    let lastSparkleTime = 0;
    function initSparkleTrail() {
      if (window.matchMedia('(hover: none)').matches) return;

      document.addEventListener('mousemove', (e) => {
        const now = Date.now();
        if (now - lastSparkleTime < 60) return;
        lastSparkleTime = now;

        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle-trail';
        sparkle.style.left = e.clientX + (Math.random() * 10 - 5) + 'px';
        sparkle.style.top = e.clientY + (Math.random() * 10 - 5) + 'px';
        sparkle.style.background = Math.random() > 0.5 ? 'var(--rose)' : 'var(--gold)';
        document.body.appendChild(sparkle);

        setTimeout(() => sparkle.remove(), 300);
      });
    }

    // ========================================
    // SOUND TOGGLE
    // ========================================
    function initSoundToggle() {
      const btn = document.getElementById('sound-toggle');
      const icon = btn.querySelector('.sound-icon');

      btn.addEventListener('click', () => {
        state.soundEnabled = !state.soundEnabled;
        icon.textContent = state.soundEnabled ? 'üîä' : 'üîá';
      });
    }

    // ========================================
    // TYPEWRITER EFFECT
    // ========================================
    function typeWriter(text, callback) {
      const content = document.getElementById('typewriter-content');
      let i = 0;

      function type() {
        if (i < text.length) {
          content.textContent += text.charAt(i);
          i++;
          const delay = 50 + (Math.random() * 40 - 20);
          setTimeout(type, delay);
        } else if (callback) {
          callback();
        }
      }

      type();
    }

    // ========================================
    // PAGE TRANSITIONS
    // ========================================
    function transitionTo(pageId) {
      if (state.transitioning) return;
      state.transitioning = true;

      const currentPage = document.querySelector('.page.active');
      const nextPage = document.getElementById(pageId);

      if (currentPage) {
        currentPage.classList.add('exiting');
        setTimeout(() => {
          currentPage.classList.remove('active', 'exiting');
        }, 400);
      }

      setTimeout(() => {
        nextPage.classList.add('active', 'entering');
        state.currentPage = pageId;

        setTimeout(() => {
          nextPage.classList.remove('entering');
          state.transitioning = false;
          initPage(pageId);
        }, 400);
      }, currentPage ? 400 : 0);
    }

    // ========================================
    // LANDING PAGE
    // ========================================
    let landingInitialized = false;
    function initLanding() {
      if (landingInitialized) return;
      landingInitialized = true;

      renderTamagotchi(document.getElementById('landing-tama'), TAMA_IDLE);
      typeWriter("hey beautiful, i made something for you...", null);

      const continueBtn = document.getElementById('continue-btn');
      const tamaWrapper = document.getElementById('landing-tama');
      let isNearButton = false;

      // Desktop: tilt toward cursor and excitement near button
      if (!window.matchMedia('(hover: none)').matches) {
        document.addEventListener('mousemove', (e) => {
          if (state.currentPage !== 'landing') return;

          const rect = tamaWrapper.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const angleX = (e.clientX - centerX) / window.innerWidth * 5;
          tamaWrapper.style.transform = `translateY(${tamaWrapper.classList.contains('floating') ? '-5px' : '0'}) rotate(${angleX}deg)`;

          // Check proximity to continue button
          const btnRect = continueBtn.getBoundingClientRect();
          const btnCenterX = btnRect.left + btnRect.width / 2;
          const btnCenterY = btnRect.top + btnRect.height / 2;
          const distance = Math.hypot(e.clientX - btnCenterX, e.clientY - btnCenterY);

          if (distance < 150 && !isNearButton) {
            isNearButton = true;
            renderTamagotchi(tamaWrapper, TAMA_EXCITED);
            tamaWrapper.classList.remove('floating');
            tamaWrapper.classList.add('bouncing');

            // Float a heart
            const heart = document.createElement('div');
            heart.className = 'floating-pixel-heart animate';
            heart.style.left = '50%';
            heart.style.top = '-20px';
            heart.style.transform = 'translateX(-50%)';
            tamaWrapper.appendChild(heart);
            setTimeout(() => heart.remove(), 1500);

            setTimeout(() => {
              tamaWrapper.classList.remove('bouncing');
              tamaWrapper.classList.add('floating');
            }, 300);
          } else if (distance >= 150 && isNearButton) {
            isNearButton = false;
            renderTamagotchi(tamaWrapper, TAMA_IDLE);
          }
        });
      }

      continueBtn.addEventListener('click', () => {
        if (!debounce()) return;

        tamaWrapper.classList.remove('floating', 'bouncing');
        tamaWrapper.classList.add('waving');

        setTimeout(() => {
          transitionTo('question');
        }, 500);
      });
    }

    // ========================================
    // QUESTION PAGE
    // ========================================
    function initQuestion() {
      const words = document.querySelectorAll('#question-text .word');
      const subtitle = document.getElementById('question-subtitle');
      const buttons = document.getElementById('question-buttons');
      const noBtn = document.getElementById('no-btn');
      const yesBtn = document.getElementById('yes-btn-question');
      const questionText = document.getElementById('question-text');
      const transitionText = document.getElementById('transition-text');

      // Reset state
      state.noClickCount = 0;
      noBtn.style.position = '';
      noBtn.style.left = '';
      noBtn.style.top = '';
      questionText.classList.remove('wobbling');
      questionText.style.opacity = '1';
      subtitle.textContent = '(choose wisely)';
      subtitle.classList.remove('visible');
      buttons.classList.remove('visible');
      transitionText.classList.remove('visible');
      words.forEach(w => w.style.animation = '');

      // Word reveal animation
      words.forEach((word, i) => {
        setTimeout(() => {
          word.style.animation = 'wordReveal 0.3s ease-out forwards';
        }, i * 150);
      });

      // Show subtitle after words
      setTimeout(() => subtitle.classList.add('visible'), words.length * 150 + 300);

      // Show buttons
      setTimeout(() => buttons.classList.add('visible'), words.length * 150 + 600);

      // Set up peek container
      const peekContainer = document.getElementById('tama-peek-container');
      const peekTama = document.getElementById('peek-tama');
      peekContainer.style.display = 'block';
      renderTamagotchi(peekTama, TAMA_IDLE);

      // Yes button goes to cannon
      yesBtn.onclick = () => {
        if (!debounce()) return;
        peekContainer.style.display = 'none';
        transitionTo('cannon-page');
        setTimeout(() => initCannonSequence(), 400);
      };

      // No button dodge
      noBtn.onclick = (e) => {
        if (!debounce(300)) return;
        if (state.noClickCount >= 5) return;

        state.noClickCount++;
        handleDodgeReaction(state.noClickCount);

        if (state.noClickCount < 5) {
          // Teleport the button
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          const yesRect = yesBtn.getBoundingClientRect();

          let newX, newY, attempts = 0;
          do {
            newX = 20 + Math.random() * (vw - 160);
            newY = 100 + Math.random() * (vh - 160);
            attempts++;
          } while (
            attempts < 50 &&
            newX < yesRect.right + 40 &&
            newX + 130 > yesRect.left - 40 &&
            newY < yesRect.bottom + 40 &&
            newY + 50 > yesRect.top - 40
          );

          noBtn.style.position = 'fixed';
          noBtn.style.left = newX + 'px';
          noBtn.style.top = newY + 'px';
        }
      };
    }

    function handleDodgeReaction(count) {
      const peekTama = document.getElementById('peek-tama');
      const peekText = document.getElementById('peek-text');
      const peekExclaim = document.getElementById('peek-exclaim');
      const subtitle = document.getElementById('question-subtitle');
      const questionText = document.getElementById('question-text');
      const buttons = document.getElementById('question-buttons');
      const transitionText = document.getElementById('transition-text');
      const peekContainer = document.getElementById('tama-peek-container');
      const tamaWrapper = peekContainer.querySelector('.tamagotchi-wrapper');

      // Reset peek state
      tamaWrapper.style.top = '-120px';
      peekText.style.opacity = '0';
      peekExclaim.style.opacity = '0';

      if (count === 1) {
        // Surprise - peek with "!"
        renderTamagotchi(peekTama, TAMA_IDLE);
        setTimeout(() => {
          tamaWrapper.style.top = '20px';
          peekExclaim.style.opacity = '1';
        }, 50);

        setTimeout(() => {
          tamaWrapper.style.top = '-120px';
          peekExclaim.style.opacity = '0';
        }, 750);

      } else if (count === 2) {
        // Disbelief - wiggle + "wait what"
        renderTamagotchi(peekTama, TAMA_IDLE);
        setTimeout(() => {
          tamaWrapper.style.top = '10px';
          peekText.textContent = 'wait what';
          peekText.style.opacity = '1';

          // Wiggle
          let wiggle = 0;
          const wiggleInterval = setInterval(() => {
            wiggle++;
            tamaWrapper.style.transform = `translateX(-50%) rotate(${wiggle % 2 ? 6 : -6}deg)`;
            if (wiggle >= 4) {
              clearInterval(wiggleInterval);
              tamaWrapper.style.transform = 'translateX(-50%) rotate(0deg)';
            }
          }, 100);
        }, 50);

        setTimeout(() => {
          tamaWrapper.style.top = '-120px';
          peekText.style.opacity = '0';
        }, 1200);

      } else if (count === 3) {
        // Emotional damage - sad, slow, teardrop
        renderTamagotchi(peekTama, TAMA_SAD);
        tamaWrapper.style.transition = 'top 0.8s ease-out';

        setTimeout(() => {
          tamaWrapper.style.top = '5px';
        }, 50);

        setTimeout(() => {
          tamaWrapper.style.transition = 'top 1s ease-in';
          tamaWrapper.style.top = '-120px';
        }, 1500);

        setTimeout(() => {
          tamaWrapper.style.transition = 'top 0.4s ease-out';
        }, 2500);

        // Change subtitle
        subtitle.style.opacity = '0';
        setTimeout(() => {
          subtitle.textContent = "(you're really doing this?)";
          subtitle.style.opacity = '1';
        }, 300);

      } else if (count === 4) {
        // Giving up - barely peeks
        renderTamagotchi(peekTama, TAMA_SAD);
        setTimeout(() => {
          tamaWrapper.style.top = '50px'; // Just ears visible
        }, 50);

        setTimeout(() => {
          tamaWrapper.style.top = '-120px';
        }, 450);

      } else if (count === 5) {
        // Final stand - no peek, text shakes, transition to CAPTCHA
        peekContainer.style.display = 'none';

        questionText.classList.add('wobbling');
        subtitle.style.opacity = '0';
        setTimeout(() => {
          subtitle.textContent = "(okay fine, prove it then)";
          subtitle.style.opacity = '1';
        }, 300);

        setTimeout(() => {
          questionText.classList.remove('wobbling');
          questionText.style.transition = 'opacity 0.4s';
          questionText.style.opacity = '0';
          subtitle.style.opacity = '0';
          buttons.style.opacity = '0';

          setTimeout(() => {
            transitionText.classList.add('visible');
          }, 400);

          setTimeout(() => {
            transitionTo('captcha');
          }, 2000);
        }, 1000);
      }
    }

    // ========================================
    // CAPTCHA PAGE
    // ========================================
    const LACHIE_PHOTOS = [
      'assets/captcha/lachie-1.jpg',
      'assets/captcha/lachie-2.jpg',
      'assets/captcha/lachie-3.jpg',
      'assets/captcha/lachie-4.jpg',
      'assets/captcha/lachie-5.jpg',
      'assets/captcha/lachie-6.jpg'
    ];

    const STOCK_PHOTOS = [
      'assets/captcha/stock-1.jpg',
      'assets/captcha/stock-2.jpg',
      'assets/captcha/stock-3.jpg'
    ];

    const REJECTION_MESSAGES = [
      "Not even close",
      "Yeah... no",
      "Who is this guy?",
      "Absolutely not",
      "Try again bestie",
      "Be serious",
      "That's not even close"
    ];

    function initCaptcha() {
      const grid = document.getElementById('photo-grid');
      const verifyBtn = document.getElementById('verify-btn');
      const captchaBody = document.getElementById('captcha-body');
      const captchaContainer = document.getElementById('captcha-container');
      const subheader = document.getElementById('captcha-subheader');

      // Fade in subheader
      setTimeout(() => subheader.classList.add('visible'), 200);

      state.captchaSelections = [];
      grid.innerHTML = '';

      // Shuffle and create grid
      const allPhotos = [
        ...LACHIE_PHOTOS.map(p => ({ src: p, isLachie: true })),
        ...STOCK_PHOTOS.map(p => ({ src: p, isLachie: false }))
      ];

      // Shuffle
      for (let i = allPhotos.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allPhotos[i], allPhotos[j]] = [allPhotos[j], allPhotos[i]];
      }

      allPhotos.forEach((photo, index) => {
        const polaroid = document.createElement('div');
        polaroid.className = `polaroid ${photo.isLachie ? '' : 'stock'}`;
        polaroid.style.transform = `rotate(${-3 + Math.random() * 6}deg)`;
        polaroid.dataset.index = index;
        polaroid.dataset.isLachie = photo.isLachie;

        const photoInner = document.createElement('div');
        photoInner.className = 'photo-inner';

        const img = document.createElement('img');
        img.src = photo.src;
        img.alt = 'CAPTCHA image';
        img.onerror = () => {
          img.style.display = 'none';
          photoInner.innerHTML = `<span style="font-size:10px;color:#999;">${photo.isLachie ? 'Lachie' : 'Stock'}</span>`;
        };

        const checkmark = document.createElement('div');
        checkmark.className = 'checkmark';
        checkmark.textContent = '‚úì';

        photoInner.appendChild(img);
        polaroid.appendChild(photoInner);
        polaroid.appendChild(checkmark);

        polaroid.addEventListener('click', () => handlePhotoClick(polaroid, photo.isLachie, index, verifyBtn));

        grid.appendChild(polaroid);
      });

      verifyBtn.disabled = true;
      verifyBtn.onclick = () => handleVerify(captchaBody, captchaContainer);
    }

    function handlePhotoClick(polaroid, isLachie, index, verifyBtn) {
      if (!isLachie) {
        // Stock photo rejection
        polaroid.classList.add('rejected');

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = REJECTION_MESSAGES[Math.floor(Math.random() * REJECTION_MESSAGES.length)];
        toast.style.animation = 'toastUp 1s ease-out forwards';
        polaroid.appendChild(toast);

        setTimeout(() => {
          polaroid.classList.remove('rejected');
          toast.remove();
        }, 800);

        return;
      }

      // Toggle selection
      const selIndex = state.captchaSelections.indexOf(index);
      if (selIndex > -1) {
        state.captchaSelections.splice(selIndex, 1);
        polaroid.classList.remove('selected');
      } else {
        state.captchaSelections.push(index);
        polaroid.classList.add('selected', 'popping');
        setTimeout(() => polaroid.classList.remove('popping'), 150);
      }

      verifyBtn.disabled = state.captchaSelections.length === 0;
    }

    function handleVerify(captchaBody, captchaContainer) {
      if (!debounce()) return;

      const hasLachie = state.captchaSelections.length > 0;

      if (!hasLachie) {
        captchaBody.innerHTML = `
          <div class="error-message">
            Critical error: no husband material detected. Please try again.
          </div>
        `;
        setTimeout(() => initCaptcha(), 2000);
        return;
      }

      // Loading
      captchaBody.innerHTML = `
        <div class="loading-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      `;

      // Success
      setTimeout(() => {
        captchaBody.innerHTML = `
          <div class="success-message">
            <div class="checkmark-circle">
              <svg class="check-icon" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <span>Verification complete!</span>
          </div>
        `;
      }, 1500);

      // Transition text
      setTimeout(() => {
        captchaBody.innerHTML = `
          <div class="success-message">
            <span style="color: var(--text-primary)">Hmm... looks like the No button is broken.</span>
          </div>
        `;
      }, 2500);

      // Collapse container and show post-captcha
      setTimeout(() => {
        captchaContainer.style.transition = 'all 0.4s ease';
        captchaContainer.style.maxHeight = captchaContainer.offsetHeight + 'px';
        captchaContainer.offsetHeight; // Force reflow
        captchaContainer.style.maxHeight = '0';
        captchaContainer.style.padding = '0';
        captchaContainer.style.opacity = '0';
        captchaContainer.style.overflow = 'hidden';

        setTimeout(() => {
          showPostCaptcha();
        }, 400);
      }, 3500);
    }

    function showPostCaptcha() {
      const captchaPage = document.getElementById('captcha');
      const container = document.getElementById('captcha-container');

      container.style.display = 'none';

      const postCaptcha = document.createElement('div');
      postCaptcha.className = 'post-captcha';
      postCaptcha.innerHTML = `
        <p class="broken-text">Hmm... looks like the No button is broken.</p>
        <div class="button-row">
          <button class="btn btn-primary btn-pulse" id="yes-btn-captcha">Yes</button>
          <button class="btn btn-secondary broken-no">No</button>
        </div>
        <p class="nudge" id="captcha-nudge">Looks like there's only one option...</p>
      `;

      captchaPage.querySelector('.page-content').appendChild(postCaptcha);

      // Show nudge after delay
      setTimeout(() => {
        document.getElementById('captcha-nudge').classList.add('visible');
      }, 1500);

      // Yes button handler
      document.getElementById('yes-btn-captcha').addEventListener('click', () => {
        if (!debounce()) return;
        transitionTo('cannon-page');
        setTimeout(() => initCannonSequence(), 400);
      });
    }

    // ========================================
    // CANNON SEQUENCE
    // ========================================
    function initCannonSequence() {
      const cannon = document.getElementById('cannon');
      renderCannon(cannon);

      // Position cannon off-screen left
      cannon.style.left = '-200px';
      cannon.style.bottom = '20%';
      cannon.style.transition = 'none';
      cannon.style.opacity = '1';

      // Roll in with bounce
      setTimeout(() => {
        cannon.style.transition = 'left 1s cubic-bezier(0.34, 1.56, 0.64, 1)';
        cannon.style.left = '10%';
      }, 100);

      // Wait for cannon to settle, then fire
      setTimeout(() => {
        // Small recoil wind-up
        cannon.style.transition = 'transform 0.2s';
        cannon.style.transform = 'translateX(-3px)';

        setTimeout(() => {
          cannon.style.transform = 'translateX(0)';
          fireCannon();
        }, 200);
      }, 1200);
    }

    function fireCannon() {
      const cannon = document.getElementById('cannon');

      // Screen shake
      document.body.classList.add('shaking');
      setTimeout(() => document.body.classList.remove('shaking'), 250);

      // Calculate barrel mouth position
      const rect = cannon.getBoundingClientRect();
      const mouthX = (rect.left + rect.width * 0.88) / window.innerWidth;
      const mouthY = (rect.top + rect.height * 0.12) / window.innerHeight;

      // Main burst FROM the barrel mouth
      confetti({
        particleCount: 200,
        angle: 60,
        spread: 70,
        origin: { x: mouthX, y: mouthY },
        colors: ['#E8657A', '#D4506A', '#FADADD', '#E8B86D', '#FFFFFF'],
        gravity: 0.8,
        ticks: 250,
        shapes: ['square', 'circle'],
        scalar: 1.1
      });

      // Second burst
      setTimeout(() => {
        confetti({
          particleCount: 120,
          angle: 55,
          spread: 80,
          origin: { x: mouthX, y: mouthY },
          colors: ['#E8657A', '#E8B86D', '#FFFFFF', '#FADADD'],
          gravity: 0.9,
          ticks: 200
        });
      }, 150);

      // Third burst
      setTimeout(() => {
        confetti({
          particleCount: 80,
          angle: 70,
          spread: 100,
          origin: { x: mouthX, y: mouthY },
          colors: ['#E8657A', '#FFFFFF', '#E8B86D'],
          gravity: 1.0,
          ticks: 180
        });
      }, 300);

      // Fade cannon and transition
      setTimeout(() => {
        cannon.style.transition = 'opacity 0.3s';
        cannon.style.opacity = '0';

        setTimeout(() => {
          transitionTo('iloveyou');
        }, 300);
      }, 500);
    }

    // ========================================
    // I LOVE YOU SEQUENCE
    // ========================================
    function initILoveYou() {
      const loveText = document.getElementById('love-text');
      const loveBtn = document.getElementById('love-btn');
      const ellipsis = document.getElementById('ellipsis');
      const dots = ellipsis.querySelectorAll('.dot');

      // Reset
      loveText.textContent = 'I love you';
      loveText.style.display = 'block';
      loveBtn.style.display = 'inline-flex';
      ellipsis.style.display = 'none';
      loveText.classList.remove('visible');
      loveBtn.classList.remove('visible');
      dots.forEach(d => d.classList.remove('visible'));

      // Beat 1: Show "I love you"
      setTimeout(() => {
        loveText.classList.add('visible');
      }, 100);

      // Beat 3: Show button
      setTimeout(() => {
        loveBtn.classList.add('visible');
      }, 2500);

      // Button click handler
      loveBtn.onclick = handleLoveClick;
    }

    function handleLoveClick() {
      if (!debounce()) return;

      const loveText = document.getElementById('love-text');
      const loveBtn = document.getElementById('love-btn');
      const ellipsis = document.getElementById('ellipsis');
      const dots = ellipsis.querySelectorAll('.dot');

      // Hide button
      loveBtn.style.transition = 'opacity 0.2s';
      loveBtn.style.opacity = '0';

      // Beat 4: Change to "I love you three!"
      setTimeout(() => {
        loveBtn.style.display = 'none';
        loveText.style.transition = 'opacity 0.4s';
        loveText.style.opacity = '0';

        setTimeout(() => {
          loveText.textContent = 'I love you three!';
          loveText.style.opacity = '1';
        }, 400);
      }, 200);

      // Beat 6: Ellipsis
      setTimeout(() => {
        loveText.style.opacity = '0';

        setTimeout(() => {
          loveText.style.display = 'none';
          ellipsis.style.display = 'block';

          // Show dots one at a time
          dots.forEach((dot, i) => {
            setTimeout(() => dot.classList.add('visible'), i * 300);
          });
        }, 400);
      }, 2000);

      // Beat 8: BLACKOUT
      setTimeout(() => {
        triggerBlackout();
      }, 3800);
    }

    function triggerBlackout() {
      const overlay = document.getElementById('blackout-overlay');
      const sixtySeven = overlay.querySelector('.sixty-seven');
      const particleLayer = document.getElementById('particle-layer');

      // HARD CUT - instant blackout
      document.body.classList.add('blackout');
      particleLayer.style.opacity = '0';
      overlay.classList.add('active');

      // Hide I Love You page
      document.getElementById('iloveyou').classList.remove('active');

      // Beat 9: Hold black
      setTimeout(() => {
        // Beat 10: Flicker
        overlay.classList.add('flickering');

        setTimeout(() => {
          overlay.classList.remove('flickering');

          // Beat 11: Slide text
          sixtySeven.classList.add('sliding');
          document.body.classList.add('rumbling');

          // Beat 12: Audio
          if (state.soundEnabled) {
            try {
              const audio = document.getElementById('audio-67');
              audio.currentTime = 0;
              audio.play().catch(() => {});
            } catch (e) {}
          }
        }, 200);
      }, 500);

      // After text exits
      setTimeout(() => {
        document.body.classList.remove('rumbling');
        sixtySeven.classList.remove('sliding');

        // Beat 13: Fade to victory
        setTimeout(() => {
          overlay.style.transition = 'opacity 1s';
          overlay.style.opacity = '0';

          document.body.classList.remove('blackout');
          particleLayer.style.opacity = '1';

          transitionTo('victory');

          setTimeout(() => {
            overlay.classList.remove('active');
            overlay.style.transition = '';
            overlay.style.opacity = '1';
            sixtySeven.style.transform = '';
          }, 1000);
        }, 500);
      }, 3200);
    }

    // ========================================
    // VICTORY PAGE
    // ========================================
    function initVictory() {
      const content = document.querySelector('#victory .victory-content');
      const elements = content.querySelectorAll(':scope > *');

      // Render tamagotchi
      renderTamagotchi(document.getElementById('victory-tama'), TAMA_EXCITED);

      // Animate elements in
      elements.forEach((el, i) => {
        setTimeout(() => {
          el.style.animation = 'victoryReveal 0.4s ease-out forwards';
        }, i * 250);
      });

      // Floating hearts above tamagotchi
      const tamaSection = document.querySelector('#victory .tamagotchi-section');
      const heartInterval = setInterval(() => {
        if (state.currentPage !== 'victory') {
          clearInterval(heartInterval);
          return;
        }

        const heart = document.createElement('div');
        heart.className = 'floating-pixel-heart animate';
        heart.style.left = (30 + Math.random() * 60) + '%';
        heart.style.top = '0';
        tamaSection.appendChild(heart);

        setTimeout(() => heart.remove(), 1500);
      }, 400);

      // Mini confetti bursts
      const confettiInterval = setInterval(() => {
        if (state.currentPage !== 'victory') {
          clearInterval(confettiInterval);
          return;
        }

        confetti({
          particleCount: 15,
          origin: { x: 0.15 + Math.random() * 0.7, y: 0 },
          colors: ['#E8657A', '#FADADD', '#E8B86D'],
          gravity: 1.2,
          ticks: 150
        });
      }, 4000);

      // Calendar button
      document.getElementById('calendar-btn').onclick = () => {
        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Valentine//EN
BEGIN:VEVENT
DTSTART:20260214T100000
DTEND:20260214T180000
SUMMARY:Valentine's Day Date
DESCRIPTION:Recreating our first date + surprises
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'valentines-date.ics';
        a.click();
        URL.revokeObjectURL(url);
      };
    }

    // ========================================
    // PAGE INIT ROUTER
    // ========================================
    function initPage(pageId) {
      switch (pageId) {
        case 'landing':
          // Already initialized on load
          break;
        case 'question':
          initQuestion();
          break;
        case 'captcha':
          initCaptcha();
          break;
        case 'cannon-page':
          // Cannon sequence handled separately
          break;
        case 'iloveyou':
          initILoveYou();
          break;
        case 'victory':
          initVictory();
          break;
      }
    }

    // ========================================
    // PRELOADING
    // ========================================
    function preloadAssets() {
      // Preload CAPTCHA images
      [...LACHIE_PHOTOS, ...STOCK_PHOTOS].forEach(src => {
        new Image().src = src;
      });

      // Preload audio
      const audio = document.getElementById('audio-67');
      audio.load();
    }

    // ========================================
    // INIT
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      createParticles();
      initSparkleTrail();
      initSoundToggle();
      initLanding();
      preloadAssets();
    });

    // Handle resize
    window.addEventListener('resize', () => {
      // Recalculate No button bounds if visible
      const noBtn = document.getElementById('no-btn');
      if (state.currentPage === 'question' && noBtn.style.position === 'fixed') {
        const rect = noBtn.getBoundingClientRect();
        if (rect.right > window.innerWidth - 20 || rect.bottom > window.innerHeight - 20) {
          noBtn.style.left = Math.min(parseFloat(noBtn.style.left), window.innerWidth - 150) + 'px';
          noBtn.style.top = Math.min(parseFloat(noBtn.style.top), window.innerHeight - 100) + 'px';
        }
      }
    });
  </script>
</body>
</html>
